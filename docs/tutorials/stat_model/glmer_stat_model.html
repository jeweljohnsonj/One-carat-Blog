<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Jewel Johnson">
<meta name="dcterms.date" content="2022-08-28">
<meta name="description" content="Go beyond linear models and extend your skills to analyse non-normal datasets with random effects">
<title>one carat blog - Hierarchical and Mixed Effects Models in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/quarto-contrib/social-share-0.1.0/social-share.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/social-share-0.1.0/all.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EVCS615JQR"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-EVCS615JQR', { 'anonymize_ip': true});
</script><style>html{ scroll-behavior: smooth; }</style>
<link href="../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../../site_libs/pagedtable-1.1/js/pagedtable.js"></script><script src="../../site_libs/quarto-diagram/mermaid.min.js"></script><script src="../../site_libs/quarto-diagram/mermaid-init.js"></script><link href="../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script><script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script><script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">
<link rel="stylesheet" href="../../styles.css">
<link rel="stylesheet" href="https://cdn.knightlab.com/libs/juxtapose/latest/css/juxtapose.css">
<meta property="og:title" content="one carat blog - Hierarchical and Mixed Effects Models in R">
<meta property="og:description" content="Go beyond linear models and extend your skills to analyse non-normal datasets with random effects">
<meta property="og:image" content="https://one-carat-blog.netlify.app/tutorials/stat_model/images/stat_model_4.png">
<meta property="og:site-name" content="one carat blog">
<meta property="og:image:height" content="1080">
<meta property="og:image:width" content="1920">
<meta name="twitter:title" content="one carat blog - Hierarchical and Mixed Effects Models in R">
<meta name="twitter:description" content="Go beyond linear models and extend your skills to analyse non-normal datasets with random effects">
<meta name="twitter:image" content="https://one-carat-blog.netlify.app/tutorials/stat_model/images/stat_model_4.png">
<meta name="twitter:image-height" content="1080">
<meta name="twitter:image-width" content="1920">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../favicon.png" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">one carat blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../blog.html">Blog</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials.html">Tutorials</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://jeweljohnsonj.github.io/jewel_resume/">About me</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jeweljohnsonj/one-carat-blog"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/jeweljohnsonj"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
<div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Hierarchical and Mixed Effects Models in R</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                  <div>
        <div class="description">
          Go beyond linear models and extend your skills to analyse non-normal datasets with random effects
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">statistical modelling</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Jewel Johnson </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 28, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#prologue" id="toc-prologue" class="nav-link active" data-scroll-target="#prologue"><span class="toc-section-number">1</span>  Prologue</a></li>
  <li><a href="#making-life-easier" id="toc-making-life-easier" class="nav-link" data-scroll-target="#making-life-easier"><span class="toc-section-number">2</span>  Making life easier</a></li>
  <li><a href="#what-is-a-hierarchical-model" id="toc-what-is-a-hierarchical-model" class="nav-link" data-scroll-target="#what-is-a-hierarchical-model"><span class="toc-section-number">3</span>  What is a hierarchical model?</a></li>
  <li><a href="#building-a-mixed-effects-model" id="toc-building-a-mixed-effects-model" class="nav-link" data-scroll-target="#building-a-mixed-effects-model"><span class="toc-section-number">4</span>  Building a mixed-effects model</a></li>
  <li>
<a href="#linear-mixed-effects-model" id="toc-linear-mixed-effects-model" class="nav-link" data-scroll-target="#linear-mixed-effects-model"><span class="toc-section-number">5</span>  Linear mixed effects model</a>
  <ul class="collapse">
<li><a href="#adding-a-random-intercept" id="toc-adding-a-random-intercept" class="nav-link" data-scroll-target="#adding-a-random-intercept"><span class="toc-section-number">5.1</span>  Adding a random intercept</a></li>
  <li><a href="#adding-a-random-slope" id="toc-adding-a-random-slope" class="nav-link" data-scroll-target="#adding-a-random-slope"><span class="toc-section-number">5.2</span>  Adding a random slope</a></li>
  <li><a href="#adding-a-non-correlated-random-effects" id="toc-adding-a-non-correlated-random-effects" class="nav-link" data-scroll-target="#adding-a-non-correlated-random-effects"><span class="toc-section-number">5.3</span>  Adding a non-correlated random effects</a></li>
  <li><a href="#adding-the-same-variable-as-both-fixed-and-random-effect" id="toc-adding-the-same-variable-as-both-fixed-and-random-effect" class="nav-link" data-scroll-target="#adding-the-same-variable-as-both-fixed-and-random-effect"><span class="toc-section-number">5.4</span>  Adding the same variable as both fixed and random effect</a></li>
  </ul>
</li>
  <li><a href="#plotting-lmer-models" id="toc-plotting-lmer-models" class="nav-link" data-scroll-target="#plotting-lmer-models"><span class="toc-section-number">6</span>  Plotting lmer models</a></li>
  <li><a href="#plotting-the-residulas" id="toc-plotting-the-residulas" class="nav-link" data-scroll-target="#plotting-the-residulas"><span class="toc-section-number">7</span>  Plotting the residulas</a></li>
  <li><a href="#plotting-the-cofidence-intervals" id="toc-plotting-the-cofidence-intervals" class="nav-link" data-scroll-target="#plotting-the-cofidence-intervals"><span class="toc-section-number">8</span>  Plotting the cofidence intervals</a></li>
  <li><a href="#null-hypothesis-testing" id="toc-null-hypothesis-testing" class="nav-link" data-scroll-target="#null-hypothesis-testing"><span class="toc-section-number">9</span>  Null hypothesis testing</a></li>
  <li><a href="#model-comparison-using-anova" id="toc-model-comparison-using-anova" class="nav-link" data-scroll-target="#model-comparison-using-anova"><span class="toc-section-number">10</span>  Model comparison using ANOVA</a></li>
  <li>
<a href="#generalized-linear-mixed-effects-model" id="toc-generalized-linear-mixed-effects-model" class="nav-link" data-scroll-target="#generalized-linear-mixed-effects-model"><span class="toc-section-number">11</span>  Generalized linear mixed effects model</a>
  <ul class="collapse">
<li><a href="#logistic-mixed-effects-model" id="toc-logistic-mixed-effects-model" class="nav-link" data-scroll-target="#logistic-mixed-effects-model"><span class="toc-section-number">11.1</span>  Logistic mixed effects model</a></li>
  <li><a href="#plotting-a-logistic-mixed-effects-model" id="toc-plotting-a-logistic-mixed-effects-model" class="nav-link" data-scroll-target="#plotting-a-logistic-mixed-effects-model"><span class="toc-section-number">11.2</span>  Plotting a logistic mixed effects model</a></li>
  <li><a href="#poisson-mixed-effects-model" id="toc-poisson-mixed-effects-model" class="nav-link" data-scroll-target="#poisson-mixed-effects-model"><span class="toc-section-number">11.3</span>  Poisson mixed effects model</a></li>
  <li><a href="#plotting-a-poisson-mixed-effects-model" id="toc-plotting-a-poisson-mixed-effects-model" class="nav-link" data-scroll-target="#plotting-a-poisson-mixed-effects-model"><span class="toc-section-number">11.4</span>  Plotting a Poisson mixed effects model</a></li>
  </ul>
</li>
  <li><a href="#repeated-measures-data" id="toc-repeated-measures-data" class="nav-link" data-scroll-target="#repeated-measures-data"><span class="toc-section-number">12</span>  Repeated measures data</a></li>
  <li><a href="#fixed-effect-models-lm-and-glm-vs-mixed-effects-models-lmer-and-glmer" id="toc-fixed-effect-models-lm-and-glm-vs-mixed-effects-models-lmer-and-glmer" class="nav-link" data-scroll-target="#fixed-effect-models-lm-and-glm-vs-mixed-effects-models-lmer-and-glmer"><span class="toc-section-number">13</span>  Fixed effect models (lm and glm) vs Mixed effects models (lmer and glmer)</a></li>
  <li><a href="#conlusion" id="toc-conlusion" class="nav-link" data-scroll-target="#conlusion"><span class="toc-section-number">14</span>  Conlusion</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/jeweljohnsonj/one-carat-blog/edit/main/tutorials/stat_model/glmer_stat_model.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/jeweljohnsonj/one-carat-blog/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
TL;DR
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this article you will learn;</p>
<ol type="1">
<li><p>What is a hierarchical model/mixed effects model?</p></li>
<li><p>What are fixed effects and random effects?</p></li>
<li><p>Building a linear mixed effects model</p></li>
<li><p>Adding random intercept group and random effect slope</p></li>
<li><p>Random effect syntaxes used in <a href="https://github.com/lme4/lme4/">lme4</a> packages</p></li>
<li><p>Plotting linear mixed effects model, the residuals and the confidence intervals</p></li>
<li><p>Model comparison using ANOVA</p></li>
<li><p>Building generalized mixed effects models: <em>Logistic</em> and <em>Poisson</em></p></li>
<li><p>Plotting generalized mixed effects models</p></li>
<li><p>Repeated measures data</p></li>
<li><p>Paired t-test and repeated measures ANOVA is a special case of mixed effects model</p></li>
</ol>
</div>
</div>
<section id="prologue" class="level2" data-number="1"><h2 data-number="1" class="anchored" data-anchor-id="prologue">
<span class="header-section-number">1</span> Prologue</h2>
<p>This is the fourth tutorial in the series: Statistical modelling using R. Over the past three tutorials we learned about linear models and generalized linear models. In this tutorial, we will learn how to build and understand both linear mixed effect models and generalised linear mixed effect models. They are needed to analyse datasets which have nested structures. We will learn more about it in the coming sections.</p>
</section><section id="making-life-easier" class="level2" data-number="2"><h2 data-number="2" class="anchored" data-anchor-id="making-life-easier">
<span class="header-section-number">2</span> Making life easier</h2>
<p>Please install and load the necessary packages and datasets which are listed below for a seamless tutorial session. (Not required but can be very helpful if you are following this tutorial code by code)</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Run the following lines of code</span></span>
<span></span>
<span><span class="co"># Packages used in this tutorial</span></span>
<span><span class="va">tutorial_packages</span> <span class="op">&lt;-</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html">quos</a></span><span class="op">(</span><span class="va">AER</span>, <span class="va">broom</span>, <span class="va">lme4</span>, <span class="va">broom.mixed</span>, <span class="va">ggeffects</span>,</span>
<span>                                 <span class="va">lmerTest</span>, <span class="va">datasets</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Install required packages</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">tutorial_packages</span>, <span class="fu">rlang</span><span class="fu">::</span><span class="va"><a href="https://rlang.r-lib.org/reference/quo_label.html">quo_name</a></span><span class="op">)</span>,</span>
<span>  <span class="va">install.packages</span>,</span>
<span>  character.only <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loading the libraries</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">tutorial_packages</span>, <span class="fu">rlang</span><span class="fu">::</span><span class="va"><a href="https://rlang.r-lib.org/reference/quo_label.html">quo_name</a></span><span class="op">)</span>,</span>
<span>  <span class="va">library</span>,</span>
<span>  character.only <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Datasets used in this tutorial</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CreditCard"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"RecreationDemand"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"sleep"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="what-is-a-hierarchical-model" class="level2" data-number="3"><h2 data-number="3" class="anchored" data-anchor-id="what-is-a-hierarchical-model">
<span class="header-section-number">3</span> What is a hierarchical model?</h2>
<p>Consider a dataset of test scores of students in different classrooms across different schools. If we take a closer look into this dataset, we can see that students can be grouped into their respective genders. This group of genders will be ‘nested’ in the group of students. Likewise the student group is nested inside the group of classrooms which is further nested into the group of schools. This is shown in the flowchart given below (Use the scroll bar below the flowchart to navigate).</p>
<div class="cell">
<div class="cell-output-display">
<div>
<p>
</p>
<pre class="mermaid" data-tooltip-selector="#mermaid-tooltip-1">%%{init: {'securityLevel': 'loose', 'theme':'base'}}%%
flowchart TB
  A[Education] --&gt; B(School 1)
  A --&gt; C(School 2)
  A --&gt; D(School 3)
  B --&gt; E(Classroom 1)
  B --&gt; F(Classroom 2)
  C --&gt; G(Classroom 1)
  D --&gt; H(Classroom 1)
  D --&gt; I(Classroom 2)
  D --&gt; J(Classroom 3)
  E --&gt; K(Males: 30, Females: 25)
  F --&gt; L(Males: 15, Females: 45)
  G --&gt; M(Males: 23, Females: 10)
  H --&gt; N(Males: 10, Females: 40)
  I --&gt; O(Males: 0, Females: 30)
  J --&gt; P(Males: 45, Females: 0)
  K --&gt; Q(Test scores)
  L --&gt; R(Test scores)
  M --&gt; S(Test scores)
  N --&gt; T(Test scores)
  O --&gt; U(Test scores)
  P --&gt; V(Test scores)
  subgraph G_1[Schools]
  B
  C
  D
  end
  style G_1 fill:#f77f00
  subgraph G_2[Classrooms]
  E
  F
  G
  H
  I
  J
  end
  style G_2 fill:#fcbf49
  subgraph G_3[Students]
  K
  L
  M
  N
  O
  P
  end
  style G_3 fill:#eae2b
  subgraph G_4[Test Scores]
  Q
  R
  S
  T
  U
  V
  end
  style G_4 fill:#f8f1ae
</pre>
<div id="mermaid-tooltip-1" class="mermaidTooltip">

</div>

</div>
</div>
</div>
<p>Student test scores are nested under the group of students. Students themselves form a group of males and females. Building from this, students are nested under classrooms. Now classrooms follow the same route and group themselves inside schools which further forms yet another group. This is an example of nested data or hierarchical data where the data is nested within itself or has a well-defined hierarchy within itself.</p>
<p>Let us take a scenario where we are introducing a new study method to students which have the potential to raise test scores. We can train students using the new method and compare the test scores to the earlier test scores before the introduction of the novel method.</p>
<p>Our goal is to see if the new study method imparts an effect on the test scores of students and we hypothesise that it will improve the scores. But because of the nature of the data, the test scores can also be affected by the sample size of the students, the sex of the student, the classroom and the school, all of which can impact the test scores. Further, we are sampling the scores of the same students over time after the introduction of the novel test method. This makes the test scores a repeated measure variable and they are not independent across time. Thus our dataset is both nested and sampled across time.</p>
<p>So how do we test if the novel study method affects the test scores by accounting for nestedness and repeated measures?</p>
<p>We can see that linear models won’t do a good job at this. Then, from our understanding of generalized linear models, we might be able to tackle this question. Since we test scores which count data, we can use the Poisson model to predict ‘test scores’ using ‘test method’ as our main explanatory variable and use other variables like student sex, classroom size, school etc. as covariates. But in doing so we are also including the variances in test scores resulting from all the covariates present in our data. This is where mixed effect models or hierarchical models shine as they treat the covariates as ‘random effects’ and pool shared information on the means of the test scores across different groups. Mixed effect models try to account for the nestedness of the data by eliminating some of the variance brought by the random effect variables on the response variable by ‘controlling’ them. Also, since we have different sample sizes for classroom students, classrooms with lower sample sizes will be impacted more by outliers. Thus treating classroom size as a random effect can mitigate this problem.</p>
<p>Here, the ‘random effects’ are the variables; sex of the student, classroom size, and school and the ‘fixed effect’, which is the variable that we are interested in, is the study method. A statistical model which has both random and fixed effect variables is called a ‘mixed effect’ model or a ‘hierarchical’ model.</p>
<p>The definitions of random effect and fixed effect are ambiguous in the scientific literature and there are multiple definitions of what constitutes a random effect and a fixed effect <span class="citation" data-cites="gelman_analysis_2005">(<a href="#ref-gelman_analysis_2005" role="doc-biblioref">Gelman 2005</a>)</span>.</p>
<p>Gelman <span class="citation" data-cites="gelman_analysis_2005">(<a href="#ref-gelman_analysis_2005" role="doc-biblioref">2005</a>)</span> suggest parting ways with the terms ‘random’ and ‘fixed’ and propose to view them as <em>constant</em> and <em>varying</em>;</p>
<blockquote class="blockquote">
<p>We define effects (or coefficients) in a multilevel model as <em>constant</em> if they are identical for all groups in a population and <em>varying</em> if they are allowed to differ from group to group. For example, the model <span class="math inline">y_{ij} = α_j +βx_{ij}</span> (of units i in groups j ) has a constant slope and varying intercepts, and <span class="math inline">y_{ij} = α_j + β_j x_{ij}</span> has varying slopes and intercepts. <span class="citation" data-cites="gelman_analysis_2005">(<a href="#ref-gelman_analysis_2005" role="doc-biblioref">Gelman 2005</a>)</span></p>
</blockquote>
</section><section id="building-a-mixed-effects-model" class="level2" data-number="4"><h2 data-number="4" class="anchored" data-anchor-id="building-a-mixed-effects-model">
<span class="header-section-number">4</span> Building a mixed-effects model</h2>
<p>We will start with a linear mixed-effects model. As seen before, we use this if our residuals follow a normal or simply if our data is normally distributed. If we have count data or binomial data which is not normally distributed, then instead of building a linear mixed effects model we build a generalized linear mixed effects model. We will use the <a href="https://github.com/lme4/lme4/">lme4</a> package in R to build these models.</p>
<p>We will be using the <code>CASchools</code> dataset from the <code>{AER}</code> package in R. The dataset contains test scores which are on the Stanford 9 standardized test administered to 5th-grade students. The dataset has values for 420 elementary schools and the test scores are given as the mean score in reading and their ability to do maths. Other variables correspond to the school characteristics which we will see later along the way.</p>
</section><section id="linear-mixed-effects-model" class="level2" data-number="5"><h2 data-number="5" class="anchored" data-anchor-id="linear-mixed-effects-model">
<span class="header-section-number">5</span> Linear mixed effects model</h2>
<p>With the <code>CASchools</code> dataset, we are interested in seeing if the reading scores (<code>read</code>) are predicted by the school expenditure (<code>expenditure</code>). Let us start by plotting the data.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'AER'</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the data</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">CASchools</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">expenditure</span>, <span class="va">read</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Reading scores vs Expenditure"</span>,</span>
<span>                    x <span class="op">=</span> <span class="st">"Expenditure per student (in dollars)"</span>,</span>
<span>                    y <span class="op">=</span> <span class="st">"Average reading score"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="glmer_stat_model_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>There does not seem to be a general trend that higher expenditure leads to higher scores. Also, most counties tend to have expenditures between 4500 and 5500 dollars.</p>
<p>Now let us try to build a linear model to predict the average reading score (<code>read</code>) with expenditure per student (<code>expenditure</code>) using the <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'broom'</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear model</span></span>
<span><span class="va">model_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extracting coefficients from the model</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">model_lm</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["term"],"name":[1],"type":["chr"],"align":["left"]},{"label":["estimate"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["std.error"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["statistic"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["p.value"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"(Intercept)","2":"6.182486e+02","3":"8.100707489","4":"76.32033","5":"1.576607e-247"},{"1":"expenditure","2":"6.912466e-03","3":"0.001514148","4":"4.56525","5":"6.570563e-06"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>From the coefficient values, we can see that the slope value for expenditure per student is almost zero. This was more or less visible to us from the plot. So does it mean that expenditure has no association with the average reading scores? Before jumping to a conclusion, if we take a closer look at the data, we can see that the scores are nested within counties (<code>county</code>). So let us try adding the variable <code>county</code> to the linear model.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear model</span></span>
<span><span class="va">model_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="va">county</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extracting coefficients from the model</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">model_lm</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["term"],"name":[1],"type":["chr"],"align":["left"]},{"label":["estimate"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["std.error"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["statistic"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["p.value"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"(Intercept)","2":"6.858039e+02","3":"18.525760642","4":"37.0189309","5":"4.040301e-127"},{"1":"expenditure","2":"9.077844e-04","3":"0.001478371","4":"0.6140437","5":"5.395597e-01"},{"1":"countyButte","2":"-4.469788e+01","3":"17.241321172","4":"-2.5924856","5":"9.902128e-03"},{"1":"countyCalaveras","2":"-2.738092e+01","3":"22.582896733","4":"-1.2124626","5":"2.261007e-01"},{"1":"countyContra Costa","2":"-1.544451e+01","3":"17.120866542","4":"-0.9020868","5":"3.675914e-01"},{"1":"countyEl Dorado","2":"-2.244417e+01","3":"16.794043740","4":"-1.3364361","5":"1.822193e-01"},{"1":"countyFresno","2":"-5.503647e+01","3":"16.655706026","4":"-3.3043615","5":"1.043858e-03"},{"1":"countyGlenn","2":"-2.519816e+01","3":"18.647714802","4":"-1.3512733","5":"1.774247e-01"},{"1":"countyHumboldt","2":"-2.650967e+01","3":"16.460972127","4":"-1.6104562","5":"1.081419e-01"},{"1":"countyImperial","2":"-5.319224e+01","3":"17.332936645","4":"-3.0688535","5":"2.305544e-03"},{"1":"countyInyo","2":"-2.771493e+01","3":"22.612621444","4":"-1.2256398","5":"2.211055e-01"},{"1":"countyKern","2":"-5.291556e+01","3":"16.332888797","4":"-3.2398166","5":"1.303177e-03"},{"1":"countyKings","2":"-4.219708e+01","3":"16.883861201","4":"-2.4992555","5":"1.287339e-02"},{"1":"countyLake","2":"-4.818474e+01","3":"19.544907603","4":"-2.4653346","5":"1.413684e-02"},{"1":"countyLassen","2":"-2.671234e+01","3":"17.591470576","4":"-1.5184822","5":"1.297377e-01"},{"1":"countyLos Angeles","2":"-4.535997e+01","3":"16.351665488","4":"-2.7740277","5":"5.814300e-03"},{"1":"countyMadera","2":"-3.755584e+01","3":"17.501873963","4":"-2.1458184","5":"3.253059e-02"},{"1":"countyMarin","2":"-6.544586e+00","3":"16.910911936","4":"-0.3870037","5":"6.989736e-01"},{"1":"countyMendocino","2":"-4.863217e+01","3":"22.547689601","4":"-2.1568581","5":"3.165339e-02"},{"1":"countyMerced","2":"-5.532178e+01","3":"16.737190885","4":"-3.3053207","5":"1.040394e-03"},{"1":"countyMonterey","2":"-5.155600e+01","3":"17.135352049","4":"-3.0087507","5":"2.800895e-03"},{"1":"countyNevada","2":"-2.145148e+01","3":"16.847068718","4":"-1.2733062","5":"2.037002e-01"},{"1":"countyOrange","2":"-3.770660e+01","3":"16.778473836","4":"-2.2473202","5":"2.520193e-02"},{"1":"countyPlacer","2":"-2.150307e+01","3":"16.770161517","4":"-1.2822220","5":"2.005590e-01"},{"1":"countyRiverside","2":"-5.148077e+01","3":"17.956121231","4":"-2.8670317","5":"4.377954e-03"},{"1":"countySacramento","2":"-5.234992e+01","3":"17.129186206","4":"-3.0561827","5":"2.402728e-03"},{"1":"countySan Benito","2":"-4.140062e+01","3":"18.498866431","4":"-2.2380086","5":"2.580854e-02"},{"1":"countySan Bernardino","2":"-4.212670e+01","3":"16.840840694","4":"-2.5014608","5":"1.279483e-02"},{"1":"countySan Diego","2":"-3.126043e+01","3":"16.378928121","4":"-1.9085763","5":"5.708203e-02"},{"1":"countySan Joaquin","2":"-4.710529e+01","3":"17.360009913","4":"-2.7134369","5":"6.966916e-03"},{"1":"countySan Luis Obispo","2":"-2.244609e+01","3":"19.621419211","4":"-1.1439586","5":"2.533725e-01"},{"1":"countySan Mateo","2":"-2.151576e+01","3":"16.432616845","4":"-1.3093328","5":"1.912255e-01"},{"1":"countySanta Barbara","2":"-2.405862e+01","3":"16.725421998","4":"-1.4384463","5":"1.511437e-01"},{"1":"countySanta Clara","2":"-2.549658e+01","3":"16.379703998","4":"-1.5565961","5":"1.204122e-01"},{"1":"countySanta Cruz","2":"-1.404995e+01","3":"17.057015110","4":"-0.8237048","5":"4.106323e-01"},{"1":"countyShasta","2":"-3.067002e+01","3":"16.596496414","4":"-1.8479818","5":"6.539432e-02"},{"1":"countySiskiyou","2":"-3.803616e+01","3":"16.804255031","4":"-2.2634841","5":"2.417833e-02"},{"1":"countySonoma","2":"-2.332471e+01","3":"16.248526999","4":"-1.4354970","5":"1.519813e-01"},{"1":"countyStanislaus","2":"-3.319736e+01","3":"17.190596580","4":"-1.9311348","5":"5.422179e-02"},{"1":"countySutter","2":"-3.549151e+01","3":"17.415980907","4":"-2.0378704","5":"4.226613e-02"},{"1":"countyTehama","2":"-3.718844e+01","3":"17.029523532","4":"-2.1837630","5":"2.960043e-02"},{"1":"countyTrinity","2":"-1.464436e+01","3":"19.540577296","4":"-0.7494331","5":"4.540673e-01"},{"1":"countyTulare","2":"-5.296280e+01","3":"16.426377453","4":"-3.2242530","5":"1.374067e-03"},{"1":"countyTuolumne","2":"-3.234726e+01","3":"17.278221971","4":"-1.8721404","5":"6.196736e-02"},{"1":"countyVentura","2":"-4.442150e+01","3":"16.933648929","4":"-2.6232682","5":"9.065403e-03"},{"1":"countyYuba","2":"-2.649214e+01","3":"19.579118046","4":"-1.3530812","5":"1.768470e-01"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>There are a total of 45 counties, so we get 44 intercept values and a global intercept value for the first county in the dataset (which is Alameda). We can also see that the slope for expenditure decreased furthermore and the standard error for the slope estimate also decreased as compared to the previous model. As for the intercepts for the respective counties, all counties as compared to Alameda county have negative intercepts. Now let us check the coefficients for the respective counties without any base county comparisons.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear model</span></span>
<span><span class="va">model_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="va">county</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extracting coefficients from the model</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">model_lm</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["term"],"name":[1],"type":["chr"],"align":["left"]},{"label":["estimate"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["std.error"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["statistic"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["p.value"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"expenditure","2":"9.077844e-04","3":"0.001478371","4":"0.6140437","5":"5.395597e-01"},{"1":"countyAlameda","2":"6.858039e+02","3":"18.525760642","4":"37.0189309","5":"4.040301e-127"},{"1":"countyButte","2":"6.411060e+02","3":"10.737070278","4":"59.7095818","5":"2.640817e-193"},{"1":"countyCalaveras","2":"6.584229e+02","3":"17.883010198","4":"36.8183504","5":"1.992404e-126"},{"1":"countyContra Costa","2":"6.703593e+02","3":"9.848233702","4":"68.0689925","5":"8.544138e-213"},{"1":"countyEl Dorado","2":"6.633597e+02","3":"9.329227870","4":"71.1055295","5":"2.239244e-219"},{"1":"countyFresno","2":"6.307674e+02","3":"9.210621571","4":"68.4826072","5":"1.048519e-213"},{"1":"countyGlenn","2":"6.606057e+02","3":"11.238868379","4":"58.7786662","5":"5.356547e-191"},{"1":"countyHumboldt","2":"6.592942e+02","3":"8.936065532","4":"73.7790223","5":"5.662711e-225"},{"1":"countyImperial","2":"6.326116e+02","3":"9.888525559","4":"63.9743110","5":"1.634297e-203"},{"1":"countyInyo","2":"6.580889e+02","3":"17.690862762","4":"37.1993686","5":"9.657695e-128"},{"1":"countyKern","2":"6.328883e+02","3":"8.230186712","4":"76.8984121","5":"2.765640e-231"},{"1":"countyKings","2":"6.436068e+02","3":"9.427912988","4":"68.2660914","5":"3.139938e-213"},{"1":"countyLake","2":"6.376191e+02","3":"14.128739644","4":"45.1292282","5":"2.087400e-153"},{"1":"countyLassen","2":"6.590915e+02","3":"10.210426070","4":"64.5508340","5":"7.530591e-205"},{"1":"countyLos Angeles","2":"6.404439e+02","3":"8.079251545","4":"79.2701994","5":"6.198302e-236"},{"1":"countyMadera","2":"6.482480e+02","3":"10.910911822","4":"59.4128172","5":"1.425780e-192"},{"1":"countyMarin","2":"6.792593e+02","3":"10.707939857","4":"63.4351029","5":"2.967843e-202"},{"1":"countyMendocino","2":"6.371717e+02","3":"18.307394675","4":"34.8040613","5":"2.389305e-119"},{"1":"countyMerced","2":"6.304821e+02","3":"9.100504022","4":"69.2799066","5":"1.894476e-215"},{"1":"countyMonterey","2":"6.342479e+02","3":"9.734604375","4":"65.1539421","5":"3.085545e-206"},{"1":"countyNevada","2":"6.643524e+02","3":"9.788108077","4":"67.8734205","5":"2.312638e-212"},{"1":"countyOrange","2":"6.480972e+02","3":"8.792466757","4":"73.7105146","5":"7.838486e-225"},{"1":"countyPlacer","2":"6.643008e+02","3":"8.849706944","4":"75.0647210","5":"1.330324e-227"},{"1":"countyRiverside","2":"6.343231e+02","3":"10.774540113","4":"58.8724045","5":"3.127789e-191"},{"1":"countySacramento","2":"6.334539e+02","3":"9.781729729","4":"64.7588871","5":"2.494396e-205"},{"1":"countySan Benito","2":"6.444032e+02","3":"11.932303812","4":"54.0049299","5":"1.095166e-178"},{"1":"countySan Bernardino","2":"6.436771e+02","3":"8.965825736","4":"71.7922887","5":"7.855231e-221"},{"1":"countySan Diego","2":"6.545434e+02","3":"8.725598285","4":"75.0141591","5":"1.685011e-227"},{"1":"countySan Joaquin","2":"6.386986e+02","3":"9.721697244","4":"65.6982567","5":"1.763227e-207"},{"1":"countySan Luis Obispo","2":"6.633578e+02","3":"13.527093221","4":"49.0391950","5":"5.900014e-165"},{"1":"countySan Mateo","2":"6.642881e+02","3":"9.292046589","4":"71.4899654","5":"3.421069e-220"},{"1":"countySanta Barbara","2":"6.617452e+02","3":"9.201942411","4":"71.9136463","5":"4.358199e-221"},{"1":"countySanta Clara","2":"6.603073e+02","3":"8.959991540","4":"73.6950773","5":"8.434653e-225"},{"1":"countySanta Cruz","2":"6.717539e+02","3":"10.587800247","4":"63.4460315","5":"2.797908e-202"},{"1":"countyShasta","2":"6.551338e+02","3":"9.228176945","4":"70.9927685","5":"3.891805e-219"},{"1":"countySiskiyou","2":"6.477677e+02","3":"10.647405655","4":"60.8380774","5":"4.610118e-196"},{"1":"countySonoma","2":"6.624791e+02","3":"8.875794553","4":"74.6388548","5":"9.781441e-227"},{"1":"countyStanislaus","2":"6.526065e+02","3":"9.371688301","4":"69.6359580","5":"3.196037e-216"},{"1":"countySutter","2":"6.503123e+02","3":"9.426568754","4":"68.9871742","5":"8.231353e-215"},{"1":"countyTehama","2":"6.486154e+02","3":"9.305875519","4":"69.6995579","5":"2.327624e-216"},{"1":"countyTrinity","2":"6.711595e+02","3":"14.187466209","4":"47.3065090","5":"6.375503e-160"},{"1":"countyTulare","2":"6.328411e+02","3":"7.876885616","4":"80.3415318","5":"5.400340e-238"},{"1":"countyTuolumne","2":"6.534566e+02","3":"10.309756625","4":"63.3823494","5":"3.945513e-202"},{"1":"countyVentura","2":"6.413824e+02","3":"9.060707370","4":"70.7872271","5":"1.067978e-218"},{"1":"countyYuba","2":"6.593117e+02","3":"13.799521373","4":"47.7778684","5":"2.643353e-161"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The coefficient for Alameda county is the greatest out of all the counties, which is why we got all the intercept values as negative in the earlier case. Also, the p-value associated with expenditure (p = 0.54) is greater than 0.05 suggesting that expenditure does not explain the variance seen in the average reading scores.</p>
<section id="adding-a-random-intercept" class="level3" data-number="5.1"><h3 data-number="5.1" class="anchored" data-anchor-id="adding-a-random-intercept">
<span class="header-section-number">5.1</span> Adding a random intercept</h3>
<p>What if we only want to see how expenditure affects the reading score without the county differences? Let us build a linear mixed effects model with <code>county</code> as the ‘random effect’ and ‘expenditure’ as the ‘fixed effect’. To build a linear mixed effects model we use the function <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer()</a></code> from the <a href="https://github.com/lme4/lme4/">lme4</a> package in R.</p>
<p>The syntax for building a linear mixed effects model is very similar to the syntax we used while using the <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> and <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> functions. Here we are considering <code>county</code> as a random effect, moreover, the <code>county</code> variable is categorical and therefore, we are essentially considering <code>county</code> as a random intercept.</p>
<p>The notation for specifying random effect within the model formula is <code>(1 | county)</code>. If we do not specify a random effect term in the model formula, the <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer()</a></code> function won’t run. Without further ado, let’s see it in action.</p>
<p>The <code><a href="https://generics.r-lib.org/reference/tidy.html">tidy()</a></code> function from the <a href="https://broom.tidymodels.org/">broom</a> package in R only work for models built using <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> and <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code>. To extend its usage to mixed effects models, we have to install an additional package called <a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'lme4'</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'broom.mixed'</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model</span></span>
<span><span class="va">model_lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extracting coefficients from the model</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">model_lmer</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["effect"],"name":[1],"type":["chr"],"align":["left"]},{"label":["group"],"name":[2],"type":["chr"],"align":["left"]},{"label":["term"],"name":[3],"type":["chr"],"align":["left"]},{"label":["estimate"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["std.error"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["statistic"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"fixed","2":"NA","3":"(Intercept)","4":"6.454923e+02","5":"7.802918630","6":"82.724468"},{"1":"fixed","2":"NA","3":"expenditure","4":"1.954755e-03","5":"0.001418332","6":"1.378207"},{"1":"ran_pars","2":"county","3":"sd__(Intercept)","4":"1.176853e+01","5":"NA","6":"NA"},{"1":"ran_pars","2":"Residual","3":"sd__Observation","4":"1.592921e+01","5":"NA","6":"NA"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>If we look at the slope for expenditure, it is greater than the slope value we got from the linear model but still is almost zero. The standard error for the estimated slope is also less as compared to the earlier built models. But there is a strong role of counties on the average reading score of students. How did I know that? Let us first understand the summary of the linear mixed effects model using the <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_lmer</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/lmer_summary.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Summary of the linear mixed effects model</figcaption><p></p>
</figure>
</div>
<ol type="1">
<li><p>In section 1, we can see the model formula that we used to model the data. It also tells us that the model has been fitted by REML, which stands for restricted maximum likelihood method, the method by which lmer models fit the data.</p></li>
<li><p>In section 2, there is a value denoting the REML criterion at convergence. I don’t know exactly what this is, so if I learn more about it and understand it, then I will update this text. From what I read so far, I learned that this value can be a helpful model diagnostic if our model is not ‘converging’.</p></li>
<li><p>Section 3 outputs the quantile, min-max and median values of the residual distances of the model.</p></li>
<li><p>In section 4, the variance and the standard deviation of both the random intercept variable (county) and the residual (as explained by expenditure) are given. You can see that the variance of counties is more than half the variance of the residual. This variance value is meant to capture all the influences of counties on the average reading score. If we estimate the percentage of variance county contributes as compared to the total variance, then we have;</p></li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">county_variance</span> <span class="op">=</span> <span class="fl">138.5</span></span>
<span><span class="va">residual_variance</span> <span class="op">=</span> <span class="fl">253.7</span></span>
<span><span class="va">total_variance</span> <span class="op">=</span> <span class="va">county_variance</span> <span class="op">+</span> <span class="va">residual_variance</span></span>
<span></span>
<span><span class="co"># Calculating the percentage of variance of county to the total variance</span></span>
<span><span class="va">county_variance</span> <span class="op">/</span> <span class="va">total_variance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3531362</code></pre>
</div>
</div>
<p>So the differences between counties explain ~35% of the variance that’s “leftover” after the variance explained by our fixed effects (which is expenditure here). If we had county variance as 0, then the percentage of the variance of counties to the total variance would be 0, which suggests that county is truly a random variable which does not explain the variance seen in the average reading scores.</p>
<ol start="5" type="1">
<li><p>In section 5, we have the coefficient estimates of the fixed effect variable, something which we have seen extensively in the previous tutorials. You can see that the slope of expenditure (0.001955) is close to zero which indicates that expenditure does not explain the differences seen in the average reading score. We saw the same case when we built a linear model using the same dataset.</p></li>
<li><p>In section 6, intercept and expenditure coefficients correlate -0.966. This is another value which I am not sure what it means. From what I read, it tells us that if we were to repeat the analysis using a newly sampled dataset, then with newly estimated coefficients of the fixed effect variable, the correlation value tells us how many of those fixed effect coefficients might be associated. You can read more about it <a href="https://data.library.virginia.edu/correlation-of-fixed-effects-in-lme4/">here</a>.</p></li>
</ol>
<p>Now that we got a sense of the model summary of a linear mixed effects model, let us see some more functions in R that would be useful for extracting information from the model.</p>
<ul>
<li>To extract the coefficients of the fixed effect variables, use the <code><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html">fixef()</a></code>
</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extracting the coefficients of the fixed effects</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html">fixef</a></span><span class="op">(</span><span class="va">model_lmer</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> (Intercept)  expenditure 
6.454923e+02 1.954755e-03 </code></pre>
</div>
</div>
<ul>
<li>To extract the coefficients of the random effect variables, use the <code><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef()</a></code>
</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extracting the coefficients of the fixed effects</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef</a></span><span class="op">(</span><span class="va">model_lmer</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$county
                 (Intercept)
Alameda          11.87352086
Butte            -7.99357120
Calaveras         2.53892633
Contra Costa     15.33621739
El Dorado        10.40224040
Fresno          -17.67664299
Glenn             6.54693608
Humboldt          7.30873017
Imperial        -13.90694256
Inyo              2.52932318
Kern            -16.86794250
Kings            -6.14912869
Lake             -7.25773124
Lassen            6.16396434
Los Angeles      -9.68442015
Madera           -2.26427074
Marin            22.22849626
Mendocino        -5.18932165
Merced          -17.55856455
Monterey        -13.20359371
Nevada           10.83326539
Orange           -2.23662764
Placer           11.61203226
Riverside       -11.18209338
Sacramento      -13.86645226
San Benito       -4.01536933
San Bernardino   -5.97196372
San Diego         3.11246174
San Joaquin      -9.12283927
San Luis Obispo   6.55996266
San Mateo        11.56548692
Santa Barbara     9.16868646
Santa Clara       8.23860811
Santa Cruz       15.92725798
Shasta            3.42269880
Siskiyou         -3.53860484
Sonoma           10.40368948
Stanislaus        1.60937097
Sutter           -0.00741143
Tehama           -1.72590741
Trinity          10.21145799
Tulare          -16.47382765
Tuolumne          1.76305887
Ventura          -7.73323819
Yuba              4.27007248

with conditional variances for "county" </code></pre>
</div>
</div>
<ul>
<li>To calculate the confidence intervals of the fixed effect variables, use the <code><a href="https://rdrr.io/r/stats/confint.html">confint()</a></code>
</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calculating the confidence intervals of the fixed effects</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span><span class="op">(</span><span class="va">model_lmer</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    2.5 %       97.5 %
.sig01       8.886716e+00 1.526132e+01
.sigma       1.483855e+01 1.711469e+01
(Intercept)  6.298888e+02 6.608656e+02
expenditure -8.340782e-04 4.796441e-03</code></pre>
</div>
</div>
<p>By default the <code><a href="https://rdrr.io/r/stats/confint.html">confint()</a></code> function calculates the confidence intervals at 95% level. The displayed result from the function is symmetric over the 95% level. The interpretation of 95% CI for expenditure, in this case, would be; that if we were to repeat the experiment 100 times, then, the 95 of those mean values of the slope would fall between <span class="math inline">-0.000834</span> and <span class="math inline">0.004796</span>. We have a rather wide confidence interval which includes both a negative and a positive limit which shows that we cannot say whether expenditure decrease or increase the average reading scores.</p>
<ul>
<li>We can also use the <code><a href="https://generics.r-lib.org/reference/tidy.html">tidy()</a></code> function by loading both the <a href="https://broom.tidymodels.org/">broom</a> and <a href="https://github.com/bbolker/broom.mixed">broom.mixed</a> packages to display the estimates and the confidence intervals.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculating the estimates and the confidence intervals of the model</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">model_lmer</span>, conf.int <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["effect"],"name":[1],"type":["chr"],"align":["left"]},{"label":["group"],"name":[2],"type":["chr"],"align":["left"]},{"label":["term"],"name":[3],"type":["chr"],"align":["left"]},{"label":["estimate"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["std.error"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["statistic"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["conf.low"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["conf.high"],"name":[8],"type":["dbl"],"align":["right"]}],"data":[{"1":"fixed","2":"NA","3":"(Intercept)","4":"6.454923e+02","5":"7.802918630","6":"82.724468","7":"6.301989e+02","8":"6.607857e+02"},{"1":"fixed","2":"NA","3":"expenditure","4":"1.954755e-03","5":"0.001418332","6":"1.378207","7":"-8.251245e-04","8":"4.734635e-03"},{"1":"ran_pars","2":"county","3":"sd__(Intercept)","4":"1.176853e+01","5":"NA","6":"NA","7":"NA","8":"NA"},{"1":"ran_pars","2":"Residual","3":"sd__Observation","4":"1.592921e+01","5":"NA","6":"NA","7":"NA","8":"NA"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>You can see that the random effect variables do not have standard error values. If we compare the model summary between the linear model and the linear mixed effects model we built, we can also see that p-values are not reported for the linear mixed effects model. The author of the <a href="https://github.com/lme4/lme4/">lme4</a> package, Dr.&nbsp;Doug Bates views random effects as latent variables which do not have standard deviations and thus standard errors or p-values are <a href="https://stat.ethz.ch/pipermail/r-help/2006-May/094765.html">not calculated</a> for them. In addition to this, it is an open research question on how to calculate the p-values for random effects in a mixed-effects model. But using the <a href="https://github.com/runehaubo/lmerTestR">lmerTest</a> package in R we can perform ad-hoc analyses to report p-values for the fixed effect variables. We will see how to do this further down the section.</p>
</section><section id="adding-a-random-slope" class="level3" data-number="5.2"><h3 data-number="5.2" class="anchored" data-anchor-id="adding-a-random-slope">
<span class="header-section-number">5.2</span> Adding a random slope</h3>
<p>So far we have seen how to input random intercepts, now we will see how to input random slopes. The default syntax for random effect in R is <code>(continuous_predictor | random_effect_group)</code>. Thus a random slope is calculated, it also estimates a random effect intercept.</p>
<p>In the <code>CASchools</code> dataset, we looked at whether the average reading score is predicted by the expenditure by treating counties as the random intercept group. Now in our datasets, we also have data on the number of students and this could be different for different counties and can affect the average reading score. So this time let us build a model by treating <code>students</code> as the random effect variable.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model using random slope and random intercept</span></span>
<span><span class="va">model_lmer2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="op">(</span><span class="va">students</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extracting coefficients from the model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_lmer2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: read ~ expenditure + (students | county)
   Data: CASchools

REML criterion at convergence: 3593.2

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-2.67995 -0.64452  0.00953  0.66738  2.52830 

Random effects:
 Groups   Name        Variance  Std.Dev.  Corr 
 county   (Intercept) 3.475e+02 18.642621      
          students    1.354e-06  0.001164 -0.95
 Residual             2.342e+02 15.303481      
Number of obs: 420, groups:  county, 45

Fixed effects:
             Estimate Std. Error t value
(Intercept) 6.467e+02  7.706e+00  83.918
expenditure 6.341e-04  1.413e-03   0.449

Correlation of Fixed Effects:
            (Intr)
expenditure -0.958
optimizer (nloptwrap) convergence code: 0 (OK)
boundary (singular) fit: see help('isSingular')</code></pre>
</div>
</div>
<p>The variance of students is very less and therefore might not be affecting the scores that much. Also, note that we got an error message in the output saying <code>boundary (singular) fit</code>. This generally indicates that the estimate for the random effect variable that we used is very small. In our, it means that the random effect slopes of students are very small which we can see using the <code><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef()</a></code> function. So we can remove <code>students</code> from our model.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef</a></span><span class="op">(</span><span class="va">model_lmer2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$county
                (Intercept)      students
Alameda          24.4785039 -1.441929e-03
Butte            -3.4180179  1.775858e-04
Calaveras         7.9826401 -4.681762e-04
Contra Costa     25.4891245 -1.424787e-03
El Dorado        17.9072929 -1.012206e-03
Fresno          -14.0623193  8.308013e-04
Glenn            12.4209156 -7.319719e-04
Humboldt         13.8328480 -8.081011e-04
Imperial        -12.2869252  7.016373e-04
Inyo              7.7750632 -4.532749e-04
Kern            -12.5277014  4.649777e-04
Kings            -1.0528421  1.423524e-05
Lake             -5.6736709  3.339620e-04
Lassen           12.5326580 -7.406065e-04
Los Angeles      -2.0794607 -2.426704e-04
Madera            2.8489240 -1.656228e-04
Marin            34.7443486 -2.051422e-03
Mendocino        -4.6943124  2.762367e-04
Merced          -14.2569750  7.113461e-04
Monterey         -8.4968704  2.996187e-04
Nevada           18.6703498 -1.085232e-03
Orange            8.6097926 -6.360256e-04
Placer           19.4641692 -1.099682e-03
Riverside       -10.6949200  6.195711e-04
Sacramento      -12.6097930  7.103399e-04
San Benito        0.1126231 -3.550850e-05
San Bernardino    2.9274439 -3.988533e-04
San Diego        14.1621214 -8.451098e-04
San Joaquin      -6.2010253  3.738934e-04
San Luis Obispo  13.5823846 -7.993061e-04
San Mateo        24.7224461 -1.651387e-03
Santa Barbara    20.4963141 -1.417024e-03
Santa Clara      22.7310750 -1.376439e-03
Santa Cruz       26.5648214 -1.605235e-03
Shasta           10.2142367 -6.282100e-04
Siskiyou          2.5622804 -1.403162e-04
Sonoma           18.0499478 -1.078872e-03
Stanislaus        9.0155040 -5.928210e-04
Sutter            4.5333780 -2.714554e-04
Tehama            3.3731884 -2.120293e-04
Trinity          19.7049606 -1.160587e-03
Tulare          -12.6199437  7.048954e-04
Tuolumne          7.6541244 -4.484524e-04
Ventura          -1.4092318 -1.002546e-04
Yuba             10.9917466 -6.477161e-04

with conditional variances for "county" </code></pre>
</div>
</div>
</section><section id="adding-a-non-correlated-random-effects" class="level3" data-number="5.3"><h3 data-number="5.3" class="anchored" data-anchor-id="adding-a-non-correlated-random-effects">
<span class="header-section-number">5.3</span> Adding a non-correlated random effects</h3>
<p>Please also note that in the model summary given above, a correlation value (-0.95) is given for the correlation between <code>students</code> and <code>county</code>. If we don’t want to specify any correlation between the random effects then instead of using <code>|</code> we use <code>||</code> to specify no correlation.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model (no correlation between random effects)</span></span>
<span><span class="va">model_lmer3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="op">(</span><span class="va">students</span> <span class="op">||</span> <span class="va">county</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extracting coefficients from the model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_lmer3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: read ~ expenditure + ((1 | county) + (0 + students | county))
   Data: CASchools

REML criterion at convergence: 3592.6

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-2.73060 -0.62225  0.01112  0.63847  2.40069 

Random effects:
 Groups   Name        Variance  Std.Dev.
 county   (Intercept) 1.311e+02 11.44819
 county.1 students    2.434e-06  0.00156
 Residual             2.400e+02 15.49234
Number of obs: 420, groups:  county, 45

Fixed effects:
             Estimate Std. Error t value
(Intercept) 6.503e+02  7.738e+00  84.039
expenditure 1.321e-03  1.401e-03   0.943

Correlation of Fixed Effects:
            (Intr)
expenditure -0.966
optimizer (nloptwrap) convergence code: 0 (OK)
Model failed to converge with max|grad| = 8.66886 (tol = 0.002, component 1)
Model is nearly unidentifiable: very large eigenvalue
 - Rescale variables?
Model is nearly unidentifiable: large eigenvalue ratio
 - Rescale variables?</code></pre>
</div>
</div>
<p>The model outputs a lot of error values because <code>students</code> and <code>county</code> is correlated as seen before.</p>
</section><section id="adding-the-same-variable-as-both-fixed-and-random-effect" class="level3" data-number="5.4"><h3 data-number="5.4" class="anchored" data-anchor-id="adding-the-same-variable-as-both-fixed-and-random-effect">
<span class="header-section-number">5.4</span> Adding the same variable as both fixed and random effect</h3>
<p>Sometimes we can have a model with both the fixed effect and the random effect as the same variable. Suppose we are interested in seeing the average effect of expenditure on the average reading scores across counties. In that case, we use <code>expenditure</code> both as a fixed effect and as a random effect. Before using <code>expenditure</code> in the model formula, it is better to use the <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> function to rescale the data values for better numerical stability.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rescaling expenditure values</span></span>
<span><span class="va">CASchools_scaled</span> <span class="op">&lt;-</span> <span class="va">CASchools</span></span>
<span><span class="va">CASchools_scaled</span><span class="op">$</span><span class="va">expenditure_scaled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">CASchools_scaled</span><span class="op">$</span><span class="va">expenditure</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model (same fixed and random effect)</span></span>
<span><span class="va">model_lmer4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="op">(</span><span class="va">expenditure</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extracting coefficients from the model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_lmer4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: read ~ expenditure + (expenditure | county)
   Data: CASchools

REML criterion at convergence: 3563.6

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-2.63568 -0.62932  0.02378  0.64384  2.60189 

Random effects:
 Groups   Name        Variance  Std.Dev.  Corr 
 county   (Intercept) 6.566e+02 25.623717      
          expenditure 3.880e-05  0.006229 -0.94
 Residual             2.254e+02 15.014211      
Number of obs: 420, groups:  county, 45

Fixed effects:
             Estimate Std. Error t value
(Intercept) 6.534e+02  9.100e+00  71.801
expenditure 3.237e-04  1.828e-03   0.177

Correlation of Fixed Effects:
            (Intr)
expenditure -0.976
optimizer (nloptwrap) convergence code: 0 (OK)
unable to evaluate scaled gradient
Model failed to converge: degenerate  Hessian with 1 negative eigenvalues</code></pre>
</div>
</div>
<p>The table below shows all the different types of random effect syntaxes we can use in the <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer()</a></code> function.</p>
<table class="table">
<caption>Different random effect syntaxes used in the <a href="https://github.com/lme4/lme4/">lme4</a> package</caption>
<thead><tr class="header">
<th>Random effect syntax</th>
<th>What it means</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>(1 | group)</td>
<td>Random intercept with fixed mean</td>
</tr>
<tr class="even">
<td>(1 | g1/g2)</td>
<td>Intercepts vary among g1 and g2 within g1</td>
</tr>
<tr class="odd">
<td>(1 | g1) + (1 | g2)</td>
<td>Random intercepts for 2 variables</td>
</tr>
<tr class="even">
<td>x + (x | g)</td>
<td>Correlated random slope and intercept</td>
</tr>
<tr class="odd">
<td>x + (x || g)</td>
<td>Uncorrelated random slope and intercept</td>
</tr>
</tbody>
</table></section></section><section id="plotting-lmer-models" class="level2" data-number="6"><h2 data-number="6" class="anchored" data-anchor-id="plotting-lmer-models">
<span class="header-section-number">6</span> Plotting lmer models</h2>
<p>Earlier we had functions like <code>fmodel()</code> from the <code>{statisticalModeling}</code> package and arguments like <code><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth()</a></code> or <code><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">stat_smooth()</a></code> from the <a href="https://ggplot2.tidyverse.org">ggplot2</a> package in R to help us plot linear models and generalized linear models. Thanks to the <a href="https://strengejacke.github.io/ggeffects/">ggeffects</a> package in R, we have an easy of plotting our lmer models. But first, let us see how we got it with the <a href="https://ggplot2.tidyverse.org">ggplot2</a> package in R.</p>
<p>We will have to do some manual tidying and wrangling of our model object to extract values which we need to plot using the <a href="https://ggplot2.tidyverse.org">ggplot2</a> package.</p>
<p>To plot the trend line, we can use the <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> function to predict values using the training dataset itself and save those predicted values into a new column in the dataset. Then plot the trend lines them using those predicted values.</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear model</span></span>
<span><span class="va">model_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="va">county</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model</span></span>
<span><span class="va">model_lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Saving predicted values for each model</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">CASchools</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>predicted_lm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_lm</span><span class="op">)</span>,</span>
<span>                             predicted_lmer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_lmer</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the predicted values as lines</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">expenditure</span>, y <span class="op">=</span> <span class="va">read</span>, color <span class="op">=</span> <span class="va">county</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">expenditure</span>, y <span class="op">=</span> <span class="va">predicted_lm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">expenditure</span>, y <span class="op">=</span> <span class="va">predicted_lmer</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Linear models vs Linear mixed effects model"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Expenditure per student (in dollars)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Average reading score"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="glmer_stat_model_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We have 54 different counties which make the plot somewhat overwhelming.</p>
<p>We can also plot the predicted values as data points in the plot. Let us build another model without any groups using the same dataset. We will use the number of teachers in the school (<code>teachers</code>) as a random effect instead of the counties.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear model</span></span>
<span><span class="va">model_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="va">teachers</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model</span></span>
<span><span class="va">model_lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">teachers</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Saving predicted values for each model</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">CASchools</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>predicted_lm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_lm</span><span class="op">)</span>,</span>
<span>                             predicted_lmer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_lmer</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the predicted values as points</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">expenditure</span>, y <span class="op">=</span> <span class="va">read</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>,</span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">expenditure</span>, y <span class="op">=</span> <span class="va">predicted_lm</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>,</span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">expenditure</span>, y <span class="op">=</span> <span class="va">predicted_lmer</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">'blue'</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Linear models vs Linear mixed effects model"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Expenditure per student (in dollars)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Average reading score"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="glmer_stat_model_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>With the <a href="https://strengejacke.github.io/ggeffects/">ggeffects</a> package, plotting a lmer model is as easy as two lines of code. Since we have 54 counties, I am not plotting them via counties, so it is not included in the <code>terms = "c()"</code> argument.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://strengejacke.github.io/ggeffects/">ggeffects</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'ggeffects'</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://strengejacke.github.io/ggeffects/">ggeffects</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model</span></span>
<span><span class="va">model_lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Predicting values</span></span>
<span><span class="va">model_lmer_predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://strengejacke.github.io/ggeffects/reference/ggpredict.html">ggpredict</a></span><span class="op">(</span><span class="va">model_lmer</span>, terms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expenditure"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_lmer_predict</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="glmer_stat_model_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="plotting-the-residulas" class="level2" data-number="7"><h2 data-number="7" class="anchored" data-anchor-id="plotting-the-residulas">
<span class="header-section-number">7</span> Plotting the residulas</h2>
<p>We can use the base <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> function to plot the residuals of the models.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear model</span></span>
<span><span class="va">model_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="va">county</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model</span></span>
<span><span class="va">model_lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the linear model diagnostics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_lm</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="glmer_stat_model_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Plotting the linear mixed effects model diagnostics (just the residuals actually)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_lmer</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="glmer_stat_model_files/figure-html/unnamed-chunk-21-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="plotting-the-cofidence-intervals" class="level2" data-number="8"><h2 data-number="8" class="anchored" data-anchor-id="plotting-the-cofidence-intervals">
<span class="header-section-number">8</span> Plotting the cofidence intervals</h2>
<p>We can also plot the confidence intervals of the fixed effect variables using the <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model</span></span>
<span><span class="va">model_lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extracting the coefficients</span></span>
<span><span class="va">model_lmer_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">model_lmer</span>, conf.int <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">model_lmer_coef1</span> <span class="op">&lt;-</span> <span class="va">model_lmer_coef</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">effect</span> <span class="op">==</span> <span class="st">"fixed"</span> <span class="op">&amp;</span> <span class="va">term</span> <span class="op">!=</span> <span class="st">"(Intercept)"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the 95% CI</span></span>
<span><span class="va">model_lmer_conf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">model_lmer_coef1</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">term</span>, y <span class="op">=</span> <span class="va">estimate</span>,</span>
<span>                             ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_linerange</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Linear models vs Linear mixed effects model"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Regression coefficient"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Coefficient estimate and 95% CI"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_lmer_conf</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="glmer_stat_model_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let us try including more fixed effect terms in the model. We will include the number of teachers in the school (<code>teachers</code>) and the number of students in the school (<code>students</code>) as fixed effects.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model</span></span>
<span><span class="va">model_lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="va">teachers</span> <span class="op">+</span> <span class="va">students</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extracting the coefficients</span></span>
<span><span class="va">model_lmer_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">model_lmer</span>, conf.int <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">model_lmer_coef1</span> <span class="op">&lt;-</span> <span class="va">model_lmer_coef</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">effect</span> <span class="op">==</span> <span class="st">"fixed"</span> <span class="op">&amp;</span> <span class="va">term</span> <span class="op">!=</span> <span class="st">"(Intercept)"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the 95% CI</span></span>
<span><span class="va">model_lmer_conf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">model_lmer_coef1</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">term</span>, y <span class="op">=</span> <span class="va">estimate</span>,</span>
<span>                             ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_linerange</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Linear models vs Linear mixed effects model"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Regression coefficient"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Coefficient estimate and 95% CI"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_lmer_conf</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="glmer_stat_model_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="null-hypothesis-testing" class="level2" data-number="9"><h2 data-number="9" class="anchored" data-anchor-id="null-hypothesis-testing">
<span class="header-section-number">9</span> Null hypothesis testing</h2>
<p>As mentioned earlier, p values are not calculated for fixed terms using the <a href="https://github.com/lme4/lme4/">lme4</a> package for various reasons. So if we have to calculate the p values, we have to use the <a href="https://github.com/runehaubo/lmerTestR">lmerTest</a> package in R. By loading the <a href="https://github.com/runehaubo/lmerTestR">lmerTest</a> package, the <a href="https://github.com/lme4/lme4/">lme4</a> package is automatically loaded. We don’t have to provide any special syntax for calculating the p-values, instead, p-values are automatically calculated when calling the <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/runehaubo/lmerTestR">lmerTest</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'lmerTest'</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/runehaubo/lmerTestR">lmerTest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model</span></span>
<span><span class="va">model_lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lmerTest/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">expenditure</span> <span class="op">+</span> <span class="va">teachers</span> <span class="op">+</span> <span class="va">students</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Printing model summary</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_lmer</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: read ~ expenditure + teachers + students + (1 | county)
   Data: CASchools

REML criterion at convergence: 3590.2

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-2.7343 -0.6384  0.0471  0.6343  2.2823 

Random effects:
 Groups   Name        Variance Std.Dev.
 county   (Intercept) 138.6    11.77   
 Residual             239.6    15.48   
Number of obs: 420, groups:  county, 45

Fixed effects:
              Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept) 652.737953   7.767375 412.474266  84.036   &lt;2e-16 ***
expenditure   0.001005   0.001404 410.295073   0.715   0.4749    
teachers      0.085024   0.058332 391.351530   1.458   0.1458    
students     -0.005188   0.002825 392.820325  -1.836   0.0671 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) expndt techrs
expenditure -0.964              
teachers     0.141 -0.163       
students    -0.152  0.170 -0.997
fit warnings:
Some predictor variables are on very different scales: consider rescaling</code></pre>
</div>
</div>
<p>For fixed effects, p-values are calculated to test if the coefficients are significantly different from zero.</p>
</section><section id="model-comparison-using-anova" class="level2" data-number="10"><h2 data-number="10" class="anchored" data-anchor-id="model-comparison-using-anova">
<span class="header-section-number">10</span> Model comparison using ANOVA</h2>
<p>We can use ANOVA to compare two models to see which one is better. The ANOVA test is called by the function <code><a href="https://rdrr.io/r/stats/anova.html">anova()</a></code> and it is used to compare models by comparing the amount of variability explained by each model.</p>
<p>Let us test if the number of teachers significantly affects the average reading score of students across different counties. First, we will build a ‘null model’ with just <code>county</code> as the random effect. Then we will build another model with <code>teachers</code> as the fixed effect and the rest the same as the previous model.</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CASchools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model with only random effect (null model)</span></span>
<span><span class="va">model_lmer_null</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model with fixed effect</span></span>
<span><span class="va">model_lmer_teacher</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">read</span> <span class="op">~</span> <span class="va">teachers</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">CASchools</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Comparing models using ANOVA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span><span class="va">model_lmer_null</span>, <span class="va">model_lmer_teacher</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["npar"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["AIC"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["BIC"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["logLik"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["deviance"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["Chisq"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["Df"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["Pr(>Chisq)"],"name":[8],"type":["dbl"],"align":["right"]}],"data":[{"1":"3","2":"3595.339","3":"3607.460","4":"-1794.670","5":"3589.339","6":"NA","7":"NA","8":"NA","_rn_":"model_lmer_null"},{"1":"4","2":"3575.732","3":"3591.893","4":"-1783.866","5":"3567.732","6":"21.60661","7":"1","8":"3.346957e-06","_rn_":"model_lmer_teacher"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>From the ANOVA result, it seems like adding the variable teacher made the model better as it yielded significant p-values.</p>
</section><section id="generalized-linear-mixed-effects-model" class="level2" data-number="11"><h2 data-number="11" class="anchored" data-anchor-id="generalized-linear-mixed-effects-model">
<span class="header-section-number">11</span> Generalized linear mixed effects model</h2>
<p>Same way as we made the transition from linear models to generalized linear models, we now transition from linear mixed effects model to generalized mixed effects model. As you might have guessed, we will be dealing with datasets which do not follow the normal distribution and are in the form of a count or binomial type.</p>
<p>We use the <code><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer()</a></code> function to build generalized linear mixed effects models (glmer models) and use the <code>family = " "</code> argument to specify the distribution of residuals of the data. If it’s non-normal and is count then we use <code>family = "poisson"</code> and if it’s binomial then we use <code>family = "binomial"</code>.</p>
<section id="logistic-mixed-effects-model" class="level3" data-number="11.1"><h3 data-number="11.1" class="anchored" data-anchor-id="logistic-mixed-effects-model">
<span class="header-section-number">11.1</span> Logistic mixed effects model</h3>
<p>For this exercise, we will be using the <code>CreditCard</code> dataset from the <code>{AER}</code> package in R. The dataset contains the credit history of a sample of applicants for a type of credit card. We will be building a glmer model to predict the success of the acceptance of the credit card application (<code>card</code>) using yearly income (<code>income</code>) as the fixed effect and the house ownership status (<code>owner</code>) as the random effect.</p>
<p>Let us first build a plot and visualize the data before building the model.</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CreditCard"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the data</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">CreditCard</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">income</span>, <span class="va">card</span>, col <span class="op">=</span> <span class="va">owner</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0</span>, height <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Does income affect the success in accepting a credit card application?"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Yearly income (in USD 10,000)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Was the application for a credit card accepted?"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="glmer_stat_model_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>It seems like individuals with low yearly income tend to have the most number of credit card application rejections.</p>
<p>Now let us build the model.</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CreditCard"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a logistic mixed effects model</span></span>
<span><span class="va">model_glmer_logistic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span><span class="op">(</span><span class="va">card</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">owner</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"binomial"</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">CreditCard</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Printing the summary of the model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_glmer_logistic</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: binomial  ( logit )
Formula: card ~ income + (1 | owner)
   Data: CreditCard

     AIC      BIC   logLik deviance df.resid 
  1384.1   1399.6   -689.0   1378.1     1316 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.2271  0.3708  0.4626  0.6115  0.6626 

Random effects:
 Groups Name        Variance Std.Dev.
 owner  (Intercept) 0.09638  0.3105  
Number of obs: 1319, groups:  owner, 2

Fixed effects:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  0.99357    0.27913   3.560 0.000371 ***
income       0.09610    0.04779   2.011 0.044338 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
       (Intr)
income -0.564</code></pre>
</div>
</div>
<p>From a quick look, it seems like income does significantly explain the variance seen in the success of accepting a credit card application.</p>
<p>We learned from logistic GLMs that it’s easier to interpret the coefficients as odds ratio by exponentiating them. The same principle follows here.</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed">broom.mixed</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CreditCard"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a logistic mixed effects model</span></span>
<span><span class="va">model_glmer_logistic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span><span class="op">(</span><span class="va">card</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">owner</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"binomial"</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">CreditCard</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extracting the odds ratios</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">model_glmer_logistic</span>, exponentiate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["effect"],"name":[1],"type":["chr"],"align":["left"]},{"label":["group"],"name":[2],"type":["chr"],"align":["left"]},{"label":["term"],"name":[3],"type":["chr"],"align":["left"]},{"label":["estimate"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["std.error"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["statistic"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["p.value"],"name":[7],"type":["dbl"],"align":["right"]}],"data":[{"1":"fixed","2":"NA","3":"(Intercept)","4":"2.7008586","5":"0.75388048","6":"3.559571","7":"0.0003714605"},{"1":"fixed","2":"NA","3":"income","4":"1.1008665","5":"0.05260904","6":"2.010882","7":"0.0443378740"},{"1":"ran_pars","2":"owner","3":"sd__(Intercept)","4":"0.3104551","5":"NA","6":"NA","7":"NA"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>We can see that the odds ratio for income is very close to 1, which is why the p-value associated with income is close to the level of significance of 0.05. So there is a weak effect on income in deciding the success of accepting credit card applications. There might be some other variables that we are missing to incorporate into the model.</p>
</section><section id="plotting-a-logistic-mixed-effects-model" class="level3" data-number="11.2"><h3 data-number="11.2" class="anchored" data-anchor-id="plotting-a-logistic-mixed-effects-model">
<span class="header-section-number">11.2</span> Plotting a logistic mixed effects model</h3>
<p>As we saw in the case with the linear mixed effects model, we will be using the <a href="https://strengejacke.github.io/ggeffects/">ggeffects</a> package.</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://strengejacke.github.io/ggeffects/">ggeffects</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"CreditCard"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a logistic mixed effects model</span></span>
<span><span class="va">model_glmer_logistic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span><span class="op">(</span><span class="va">card</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">owner</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"binomial"</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">CreditCard</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Predicting values</span></span>
<span><span class="va">model_glmer_logistic_predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://strengejacke.github.io/ggeffects/reference/ggpredict.html">ggpredict</a></span><span class="op">(</span><span class="va">model_glmer_logistic</span>, <span class="st">"income"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_glmer_logistic_predict</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="glmer_stat_model_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="poisson-mixed-effects-model" class="level3" data-number="11.3"><h3 data-number="11.3" class="anchored" data-anchor-id="poisson-mixed-effects-model">
<span class="header-section-number">11.3</span> Poisson mixed effects model</h3>
<p>For this exercise, we will be using the <code>RecreationDemand</code> dataset from the <code>{AER}</code> package in R. The data is on the number of recreational boating trips to Lake Somerville, Texas, in 1980, based on a survey administered to 2,000 registered leisure boat owners in 23 counties in eastern Texas, USA.</p>
<p>We will be predicting the number of boating trips (<code>trips</code>) using the annual household income of the respondent (<code>income</code>) as the fixed effect and water-skiing status at the lake (<code>ski</code>) as the random effect.</p>
<p>Let us first build a plot and visualize the data before building the model.</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"RecreationDemand"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the data</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">RecreationDemand</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">income</span>, <span class="va">trips</span>, col <span class="op">=</span> <span class="va">ski</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.05</span>, height <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Does income affect the number of recreational boating trips?"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Annual household income of the respondent (in 1,000 USD)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Number of recreational boating trips"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="glmer_stat_model_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The graph tells us that most boating trips are made by people with less annual household income. Please note that there are many zeros in the dataset, essentially we have a zero-inflated dataset. But for now, we will ignore it. Skiing status doesn’t seem to affect the number of boating trips made.</p>
<p>Now let us build the model and see.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"RecreationDemand"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a poisson mixed effects model</span></span>
<span><span class="va">model_glmer_poisson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span><span class="op">(</span><span class="va">trips</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ski</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"poisson"</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">RecreationDemand</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Printing the summary of the model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_glmer_poisson</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: poisson  ( log )
Formula: trips ~ income + (1 | ski)
   Data: RecreationDemand

     AIC      BIC   logLik deviance df.resid 
  5454.7   5468.2  -2724.4   5448.7      656 

Scaled residuals: 
   Min     1Q Median     3Q    Max 
-2.192 -1.506 -1.291 -0.242 56.932 

Random effects:
 Groups Name        Variance Std.Dev.
 ski    (Intercept) 0.09025  0.3004  
Number of obs: 659, groups:  ski, 2

Fixed effects:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  1.42434    0.22221   6.410 1.46e-10 ***
income      -0.15402    0.01674  -9.199  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
       (Intr)
income -0.269</code></pre>
</div>
</div>
<p>Seems like income has a significant negative impact on the number of boating trips as seen earlier in the graph.</p>
</section><section id="plotting-a-poisson-mixed-effects-model" class="level3" data-number="11.4"><h3 data-number="11.4" class="anchored" data-anchor-id="plotting-a-poisson-mixed-effects-model">
<span class="header-section-number">11.4</span> Plotting a Poisson mixed effects model</h3>
<p>Again we will be using the <a href="https://strengejacke.github.io/ggeffects/">ggeffects</a> package.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://strengejacke.github.io/ggeffects/">ggeffects</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"RecreationDemand"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a poisson mixed effects model</span></span>
<span><span class="va">model_glmer_poisson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span><span class="op">(</span><span class="va">trips</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ski</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"poisson"</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">RecreationDemand</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Predicting values</span></span>
<span><span class="va">model_glmer_poisson_predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://strengejacke.github.io/ggeffects/reference/ggpredict.html">ggpredict</a></span><span class="op">(</span><span class="va">model_glmer_poisson</span>,</span>
<span>                                         terms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"income"</span>, <span class="st">"ski"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_glmer_poisson_predict</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="glmer_stat_model_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section></section><section id="repeated-measures-data" class="level2" data-number="12"><h2 data-number="12" class="anchored" data-anchor-id="repeated-measures-data">
<span class="header-section-number">12</span> Repeated measures data</h2>
<p>If we measure variables across time for the same set of observations then essentially we have repeated measures data. Repeated measures are a special case of a mixed-effects model. Examples of repeated measures include; tracking test scores of students across an academic year, measuring drug effects on patients over time, measuring the growth of bacteria over time, measuring flower phenology over different seasons etc.</p>
<p>We will be using the <code>sleep</code> dataset from the <code>{datasets}</code> package in R. The data show the effect of two soporific drugs (increase in hours of sleep compared to control) on 10 patients. In this case, we are measuring sleep difference in hours across time (<code>extra</code>) for two groups (<code>group</code>), essentially repeated measured data.</p>
<p>First, let us visualize the dataset.</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">datasets</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'datasets'</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">datasets</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"sleep"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the graph</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">sleep</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">extra</span>, group <span class="op">=</span> <span class="va">ID</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Effect of two soporific drugs on sleep in 10 patients"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Drug group"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Increase in hours of sleep compared to control"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="glmer_stat_model_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The graph shows that drug 2 as compared to drug 1 increases the amount of sleep in hours when compared to control. Now let us see if this difference is statistically significant.</p>
<p>In introductory statistic classes, we would have learned that to compare means across time for this ‘paired’ dataset, we can use a paired t-test. Performing a t-test in R is through the <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> function. If we use <code>t.test(paired = T)</code> then essentially we are doing a paired t.test. Let us do a paired t-test on the above-mentioned dataset.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">datasets</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"sleep"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Performing a paired t.test</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">extra</span> <span class="op">~</span> <span class="va">group</span>, paired <span class="op">=</span> <span class="cn">T</span>, data <span class="op">=</span> <span class="va">sleep</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Paired t-test

data:  extra by group
t = -4.0621, df = 9, p-value = 0.002833
alternative hypothesis: true mean difference is not equal to 0
95 percent confidence interval:
 -2.4598858 -0.7001142
sample estimates:
mean difference 
          -1.58 </code></pre>
</div>
</div>
<p>The t-test results suggest a significant difference between the mean of the sleep differences and the difference between the mean of the sleep difference between the two groups is -1.58. In other words, group 2 has a 1.58 value greater mean as compared to group 1.</p>
<p>Now let us run a linear mixed effects model with <code>extra</code> as the response variable, <code>group</code> as the fixed effect and the <code>ID</code> as the random effect.</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">datasets</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"sleep"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effect model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">extra</span> <span class="op">~</span> <span class="va">group</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">sleep</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: extra ~ group + (1 | ID)
   Data: sleep

REML criterion at convergence: 70

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-1.63372 -0.34157  0.03346  0.31511  1.83859 

Random effects:
 Groups   Name        Variance Std.Dev.
 ID       (Intercept) 2.8483   1.6877  
 Residual             0.7564   0.8697  
Number of obs: 20, groups:  ID, 10

Fixed effects:
            Estimate Std. Error      df t value Pr(&gt;|t|)   
(Intercept)   0.7500     0.6004 11.0814   1.249  0.23735   
group2        1.5800     0.3890  9.0000   4.062  0.00283 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
       (Intr)
group2 -0.324</code></pre>
</div>
</div>
<p>If we closely compare the paired t-test result and the summary of the linear mixed effect model, we can notice some similarities.</p>
<ol type="1">
<li>The test statistic t-value is the same in both the results if we ignore the sign (4.062).</li>
<li>The p-value is the same (0.00283)</li>
<li>The coefficient for the group2 is the same as the mean difference denoted in the paired t-test result after ignoring the sign (1.5800).</li>
</ol>
<p>Paired t-test is a special case of repeated measures ANOVA. If we have only two dependent groups and if it’s normally distributed, then we use the paired t-test to compare their means. If we have more than 2 dependent groups, then we go repeated measures ANOVA. On the other hand, repeated measures ANOVA is a special case of the mixed effects model.</p>
<p>So to compare the means for paired data, we can go for two different statistical approaches;</p>
<ol type="1">
<li>Regression analysis</li>
<li>ANOVA type approach</li>
</ol>
<p>We already saw the regression analysis approach which is what we did earlier. Here, we build a linear mixed model and then examine if the drug group coefficient differs greatly from zero. In our case, the coefficient for group2 is 1.58 and is significantly greater than 0. So we can directly see that group2 significantly affects extra hours of sleep as compared to group1, without the need for any post hoc test which is needed if we are running an ANOVA.</p>
<p>So the null and alternate hypotheses for the <em>regression analysis</em> of our data would be;</p>
<ul>
<li>
<span class="math inline">H_0</span> = Drug group coefficient is zero</li>
<li>
<span class="math inline">H_a</span> = Drug group coefficient is not zero</li>
</ul>
<p>In the second approach, we examine if the drug group covariate explains a significant amount of variability within the model. There will be no effect on the drug group if the amount of sleep the study participants get in both groups is similar. ANOVA will only tell that there is a significant difference between some groups in the model, to see which groups differ from each other, we have to go for a post hoc test.</p>
<p>So the null and alternate hypothesis for the <em>ANOVA type approach</em> for our data would be;</p>
<ul>
<li>
<span class="math inline">H_0</span> = Drug group does not significantly explain the differences in extra sleep hours</li>
<li>
<span class="math inline">H_a</span> = Drug group significantly explain the differences in extra sleep hours</li>
</ul>
<p>Going forward with the ANOVA type approach can be as easy as using the function <code><a href="https://rdrr.io/r/stats/anova.html">anova()</a></code> by giving the model as the input.</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">datasets</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"sleep"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Building a linear mixed effects model</span></span>
<span><span class="va">sleep_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">extra</span> <span class="op">~</span> <span class="va">group</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">sleep</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Performing a ANOVA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span><span class="va">sleep_model</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Sum Sq"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["Mean Sq"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["NumDF"],"name":[3],"type":["int"],"align":["right"]},{"label":["DenDF"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["F value"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["Pr(>F)"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"12.482","2":"12.482","3":"1","4":"9","5":"16.50088","6":"0.00283289","_rn_":"group"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>As we have seen earlier, the drug group does significantly explain the differences in extra sleep hours of the patients. We can also see that the p-values calculated are identical to that of the model summary we saw before.</p>
</section><section id="fixed-effect-models-lm-and-glm-vs-mixed-effects-models-lmer-and-glmer" class="level2" data-number="13"><h2 data-number="13" class="anchored" data-anchor-id="fixed-effect-models-lm-and-glm-vs-mixed-effects-models-lmer-and-glmer">
<span class="header-section-number">13</span> Fixed effect models (lm and glm) vs Mixed effects models (lmer and glmer)</h2>
<p>We have reached the final level of the tutorial. Here we will compare the fixed effects models and mixed effects models and get an overall picture of the differences between them.</p>
<table class="table">
<caption>Review of fixed effects model and mixed effects model</caption>
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead><tr class="header">
<th>Fixed effects model</th>
<th>Mixed effects model</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Generally more impacted by outliers</td>
<td>More robust to outliers</td>
</tr>
<tr class="even">
<td>Use <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> or <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> in base R</td>
<td>Use <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer()</a></code> or <code><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer()</a></code> from <a href="https://github.com/lme4/lme4/">lme4</a> package in R</td>
</tr>
<tr class="odd">
<td>Easier to explain</td>
<td>Computationally harder to fit</td>
</tr>
<tr class="even">
<td>Easier to build</td>
<td>More robust to small group sizes</td>
</tr>
<tr class="odd">
<td></td>
<td>Models nested distributions</td>
</tr>
</tbody>
</table></section><section id="conlusion" class="level2" data-number="14"><h2 data-number="14" class="anchored" data-anchor-id="conlusion">
<span class="header-section-number">14</span> Conlusion</h2>
<p>Finally, we have completed the most needed things in statistical modelling that concerns a PhD student, especially if that student is studying Ecology. In summary, we learned the following things;</p>
<ol type="1">
<li><p>What is a hierarchical model/mixed effects model?</p></li>
<li><p>What are fixed effects and random effects?</p></li>
<li><p>Building a linear mixed effects model</p></li>
<li><p>Adding random intercept group and random effect slope</p></li>
<li><p>Random effect syntaxes used in <a href="https://github.com/lme4/lme4/">lme4</a> packages</p></li>
<li><p>Plotting linear mixed effects model, the residuals and the confidence intervals</p></li>
<li><p>Model comparison using ANOVA</p></li>
<li><p>Building generalized mixed effects models: <em>Logistic</em> and <em>Poisson</em></p></li>
<li><p>Plotting generalized mixed effects models</p></li>
<li><p>Repeated measures data</p></li>
<li><p>Paired t-test and repeated measures ANOVA is a special case of mixed effects model</p></li>
</ol>
<p>Now where to go from here? Normally, whatever is covered till now will be enough for most purposes as a student of science. Now if you the reader is still interested in learning more, then I welcome you to learn ‘Non-linear Modelling in R with Generalized Additive Models (GAM)’ which would raise our modelling repertoire to even higher levels. Congratulations for making it this far, I wish you all the best 👍</p>
</section><div id="quarto-appendix" class="default"><section id="last-updated-on" class="level4 unnumbered unlisted appendix"><h2 class="quarto-appendix-heading">Last updated on</h2><div class="quarto-appendix-contents">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-11-01 13:36:10 IST"</code></pre>
</div>
</div>
<!-- Do not forget to put flag counter -->
<p><a hidden="" href="https://info.flagcounter.com/ynrK"><img src="https://s11.flagcounter.com/count2/ynrK/bg_000000/txt_FFFFFF/border_F0F0F0/columns_5/maxflags_25/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" alt="Flag Counter" border="0"></a></p>


<!-- -->


</div></section><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-gelman_analysis_2005" class="csl-entry" role="doc-biblioentry">
Gelman, Andrew. 2005. <span>“Analysis of Variance—Why It Is More Important Than Ever.”</span> <em>The Annals of Statistics</em> 33 (1). <a href="https://doi.org/10.1214/009053604000001048">https://doi.org/10.1214/009053604000001048</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{johnson2022,
  author = {Jewel Johnson},
  editor = {},
  title = {Hierarchical and {Mixed} {Effects} {Models} in {R}},
  date = {2022-08-28},
  url = {https://one-carat-blog.netlify.app//tutorials/stat_model/glmer_stat_model.html},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-johnson2022" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Jewel Johnson. 2022. <span>“Hierarchical and Mixed Effects Models in
R.”</span> August 28, 2022. <a href="https://one-carat-blog.netlify.app//tutorials/stat_model/glmer_stat_model.html">https://one-carat-blog.netlify.app//tutorials/stat_model/glmer_stat_model.html</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><script src="https://giscus.app/client.js" data-repo="jeweljohnsonj/one-carat-blog" data-repo-id="R_kgDOHW124A" data-category="General" data-category-id="DIC_kwDOHW124M4CPNVL" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<pre class="markdown" data-shortcodes="false"><code>---
title: "Hierarchical and Mixed Effects Models in R"
description: "Go beyond linear models and extend your skills to analyse non-normal datasets with random effects"
date: "08/28/2022"
bibliography: references_glmer.bib
format:
  html:
    css:
      - https://cdn.knightlab.com/libs/juxtapose/latest/css/juxtapose.css
image: images/stat_model_4.png
categories: [statistical modelling]
filters:
   - social-share
share:
  permalink: "https://one-carat-blog.netlify.app/tutorials/stat_model/glmer_stat_model.html"
  description: "Hierarchical and Mixed Effects Models in R"
  twitter: true
  facebook: true
  reddit: true
  stumble: true
  tumblr: true
  linkedin: true
  email: true
---

:::{.callout-note}
## TL;DR

In this article you will learn;

1.    What is a hierarchical model/mixed effects model?

2.    What are fixed effects and random effects?

3.    Building a linear mixed effects model

4.    Adding random intercept group and random effect slope

5.    Random effect syntaxes used in `{lme4}` packages

6.    Plotting linear mixed effects model, the residuals and the confidence intervals

7.    Model comparison using ANOVA

8.    Building generalized mixed effects models: *Logistic* and *Poisson*

9.    Plotting generalized mixed effects models

10.   Repeated measures data

11.   Paired t-test and repeated measures ANOVA is a special case of mixed effects model

:::

## Prologue

This is the fourth tutorial in the series: Statistical modelling using R. Over the past three tutorials we learned about linear models and generalized linear models. In this tutorial, we will learn how to build and understand both linear mixed effect models and generalised linear mixed effect models. They are needed to analyse datasets which have nested structures. We will learn more about it in the coming sections.

## Making life easier

Please install and load the necessary packages and datasets which are listed below for a seamless tutorial session. (Not required but can be very helpful if you are following this tutorial code by code)

quarto-executable-code-5450563D

```r
#| eval: false

# Run the following lines of code

# Packages used in this tutorial
tutorial_packages &lt;- rlang::quos(AER, broom, lme4, broom.mixed, ggeffects,
                                 lmerTest, datasets)

# Install required packages
lapply(lapply(tutorial_packages, rlang::quo_name),
  install.packages,
  character.only = TRUE
)

# Loading the libraries
lapply(lapply(tutorial_packages, rlang::quo_name),
  library,
  character.only = TRUE
)

# Datasets used in this tutorial
data("CASchools")
data("CreditCard")
data("RecreationDemand")
data("sleep")
```

## What is a hierarchical model?

Consider a dataset of test scores of students in different classrooms across different schools. If we take a closer look into this dataset, we can see that students can be grouped into their respective genders. This group of genders will be 'nested' in the group of students. Likewise the student group is nested inside the group of classrooms which is further nested into the group of schools. This is shown in the flowchart given below (Use the scroll bar below the flowchart to navigate).

quarto-executable-code-5450563D

```mermaid
%%{init: {'securityLevel': 'loose', 'theme':'base'}}%%
flowchart TB
  A[Education] --&gt; B(School 1)
  A --&gt; C(School 2)
  A --&gt; D(School 3)
  B --&gt; E(Classroom 1)
  B --&gt; F(Classroom 2)
  C --&gt; G(Classroom 1)
  D --&gt; H(Classroom 1)
  D --&gt; I(Classroom 2)
  D --&gt; J(Classroom 3)
  E --&gt; K(Males: 30, Females: 25)
  F --&gt; L(Males: 15, Females: 45)
  G --&gt; M(Males: 23, Females: 10)
  H --&gt; N(Males: 10, Females: 40)
  I --&gt; O(Males: 0, Females: 30)
  J --&gt; P(Males: 45, Females: 0)
  K --&gt; Q(Test scores)
  L --&gt; R(Test scores)
  M --&gt; S(Test scores)
  N --&gt; T(Test scores)
  O --&gt; U(Test scores)
  P --&gt; V(Test scores)
  subgraph G_1[Schools]
  B
  C
  D
  end
  style G_1 fill:#f77f00
  subgraph G_2[Classrooms]
  E
  F
  G
  H
  I
  J
  end
  style G_2 fill:#fcbf49
  subgraph G_3[Students]
  K
  L
  M
  N
  O
  P
  end
  style G_3 fill:#eae2b
  subgraph G_4[Test Scores]
  Q
  R
  S
  T
  U
  V
  end
  style G_4 fill:#f8f1ae
```

Student test scores are nested under the group of students. Students themselves form a group of males and females. Building from this, students are nested under classrooms. Now classrooms follow the same route and group themselves inside schools which further forms yet another group. This is an example of nested data or hierarchical data where the data is nested within itself or has a well-defined hierarchy within itself.

Let us take a scenario where we are introducing a new study method to students which have the potential to raise test scores. We can train students using the new method and compare the test scores to the earlier test scores before the introduction of the novel method.

Our goal is to see if the new study method imparts an effect on the test scores of students and we hypothesise that it will improve the scores. But because of the nature of the data, the test scores can also be affected by the sample size of the students, the sex of the student, the classroom and the school, all of which can impact the test scores. Further, we are sampling the scores of the same students over time after the introduction of the novel test method. This makes the test scores a repeated measure variable and they are not independent across time. Thus our dataset is both nested and sampled across time.

So how do we test if the novel study method affects the test scores by accounting for nestedness and repeated measures?

We can see that linear models won't do a good job at this. Then, from our understanding of generalized linear models, we might be able to tackle this question. Since we test scores which count data, we can use the Poisson model to predict 'test scores' using 'test method' as our main explanatory variable and use other variables like student sex, classroom size, school etc. as covariates. But in doing so we are also including the variances in test scores resulting from all the covariates present in our data. This is where mixed effect models or hierarchical models shine as they treat the covariates as 'random effects' and pool shared information on the means of the test scores across different groups. Mixed effect models try to account for the nestedness of the data by eliminating some of the variance brought by the random effect variables on the response variable by 'controlling' them. Also, since we have different sample sizes for classroom students, classrooms with lower sample sizes will be impacted more by outliers. Thus treating classroom size as a random effect can mitigate this problem.

Here, the 'random effects' are the variables; sex of the student, classroom size, and school and the 'fixed effect', which is the variable that we are interested in, is the study method. A statistical model which has both random and fixed effect variables is called a 'mixed effect' model or a 'hierarchical' model.

The definitions of random effect and fixed effect are ambiguous in the scientific literature and there are multiple definitions of what constitutes a random effect and a fixed effect [@gelman_analysis_2005]. 

Gelman [-@gelman_analysis_2005] suggest parting ways with the terms 'random' and 'fixed' and propose to view them as *constant* and *varying*;

&gt;We define effects (or coefficients) in a multilevel model as *constant* if they are identical for all groups in a population and *varying* if they are allowed to differ from group to group. For example, the model $y_{ij} = α_j +βx_{ij}$ (of units i in groups j ) has a constant slope and varying intercepts, and $y_{ij} = α_j + β_j x_{ij}$ has varying slopes and intercepts. [@gelman_analysis_2005]

## Building a mixed-effects model

We will start with a linear mixed-effects model. As seen before, we use this if our residuals follow a normal or simply if our data is normally distributed. If we have count data or binomial data which is not normally distributed, then instead of building a linear mixed effects model we build a generalized linear mixed effects model. We will use the `{lme4}` package in R to build these models.

We will be using the `CASchools` dataset from the `{AER}` package in R. The dataset contains test scores which are on the Stanford 9 standardized test administered to 5th-grade students. The dataset has values for 420 elementary schools and the test scores are given as the mean score in reading and their ability to do maths. Other variables correspond to the school characteristics which we will see later along the way.

## Linear mixed effects model

With the `CASchools` dataset, we are interested in seeing if the reading scores (`read`) are predicted by the school expenditure (`expenditure`). Let us start by plotting the data.

quarto-executable-code-5450563D

```r
if (!require(AER)) install.packages('AER')
library(AER)
library(ggplot2)

data("CASchools")

# Plotting the data
ggplot(CASchools, aes(expenditure, read)) + geom_point() +
  theme_bw() + labs(title = "Reading scores vs Expenditure",
                    x = "Expenditure per student (in dollars)",
                    y = "Average reading score")
```

There does not seem to be a general trend that higher expenditure leads to higher scores. Also, most counties tend to have expenditures between 4500 and 5500 dollars.

Now let us try to build a linear model to predict the average reading score (`read`) with expenditure per student (`expenditure`) using the `lm()` function.

quarto-executable-code-5450563D

```r
if (!require(broom)) install.packages('broom')
library(AER)
library(broom)

data("CASchools")

# Building a linear model
model_lm &lt;- lm(read ~ expenditure, data = CASchools)

# Extracting coefficients from the model
tidy(model_lm)
```

From the coefficient values, we can see that the slope value for expenditure per student is almost zero. This was more or less visible to us from the plot. So does it mean that expenditure has no association with the average reading scores? Before jumping to a conclusion, if we take a closer look at the data, we can see that the scores are nested within counties (`county`). So let us try adding the variable `county` to the linear model.

quarto-executable-code-5450563D

```r
library(AER)
library(broom)

data("CASchools")

# Building a linear model
model_lm &lt;- lm(read ~ expenditure + county, data = CASchools)

# Extracting coefficients from the model
tidy(model_lm)
```

There are a total of 45 counties, so we get 44 intercept values and a global intercept value for the first county in the dataset (which is Alameda). We can also see that the slope for expenditure decreased furthermore and the standard error for the slope estimate also decreased as compared to the previous model. As for the intercepts for the respective counties, all counties as compared to Alameda county have negative intercepts. Now let us check the coefficients for the respective counties without any base county comparisons.

quarto-executable-code-5450563D

```r
#| include: true

library(AER)
library(broom)

data("CASchools")

# Building a linear model
model_lm &lt;- lm(read ~ expenditure + county - 1, data = CASchools)

# Extracting coefficients from the model
tidy(model_lm)
```

The coefficient for Alameda county is the greatest out of all the counties, which is why we got all the intercept values as negative in the earlier case. Also, the p-value associated with expenditure (p = 0.54) is greater than 0.05 suggesting that expenditure does not explain the variance seen in the average reading scores.

### Adding a random intercept

What if we only want to see how expenditure affects the reading score without the county differences? Let us build a linear mixed effects model with `county` as the 'random effect' and 'expenditure' as the 'fixed effect'. To build a linear mixed effects model we use the function `lmer()` from the `{lme4}` package in R.

The syntax for building a linear mixed effects model is very similar to the syntax we used while using the `lm()` and `glm()` functions. Here we are considering `county` as a random effect, moreover, the `county` variable is categorical and therefore, we are essentially considering `county` as a random intercept. 

The notation for specifying random effect within the model formula is `(1 | county)`. If we do not specify a random effect term in the model formula, the `lmer()` function won't run. Without further ado, let's see it in action.

The `tidy()` function from the `{broom}` package in R only work for models built using `lm()` and `glm()`. To extend its usage to mixed effects models, we have to install an additional package called `{broom.mixed}`

quarto-executable-code-5450563D

```r
#| include: true

if (!require(lme4)) install.packages('lme4')
if (!require(broom.mixed)) install.packages('broom.mixed')
library(lme4)
library(broom.mixed)
library(AER)

data("CASchools")

# Building a linear mixed effects model
model_lmer &lt;- lmer(read ~ expenditure + (1 | county), data = CASchools)

# Extracting coefficients from the model
tidy(model_lmer)
```

If we look at the slope for expenditure, it is greater than the slope value we got from the linear model but still is almost zero. The standard error for the estimated slope is also less as compared to the earlier built models. But there is a strong role of counties on the average reading score of students. How did I know that? Let us first understand the summary of the linear mixed effects model using the `summary()` function.

quarto-executable-code-5450563D

```r
#| eval: false
summary(model_lmer)
```

![Summary of the linear mixed effects model](images/lmer_summary.png)

1.    In section 1, we can see the model formula that we used to model the data. It also tells us that the model has been fitted by REML, which stands for restricted maximum likelihood method, the method by which lmer models fit the data. 

2.    In section 2, there is a value denoting the REML criterion at convergence. I don't know exactly what this is, so if I learn more about it and understand it, then I will update this text. From what I read so far, I learned that this value can be a helpful model diagnostic if our model is not 'converging'. 

3.    Section 3 outputs the quantile, min-max and median values of the residual distances of the model.

4.    In section 4, the variance and the standard deviation of both the random intercept variable (county) and the residual (as explained by expenditure) are given. You can see that the variance of counties is more than half the variance of the residual. This variance value is meant to capture all the influences of counties on the average reading score. If we estimate the percentage of variance county contributes as compared to the total variance, then we have;

quarto-executable-code-5450563D

```r
county_variance = 138.5
residual_variance = 253.7
total_variance = county_variance + residual_variance

# Calculating the percentage of variance of county to the total variance
county_variance / total_variance
```

So the differences between counties explain ~35% of the variance that’s “leftover” after the variance explained by our fixed effects (which is expenditure here). If we had county variance as 0, then the percentage of the variance of counties to the total variance would be 0, which suggests that county is truly a random variable which does not explain the variance seen in the average reading scores.

5.    In section 5, we have the coefficient estimates of the fixed effect variable, something which we have seen extensively in the previous tutorials. You can see that the slope of expenditure (0.001955) is close to zero which indicates that expenditure does not explain the differences seen in the average reading score. We saw the same case when we built a linear model using the same dataset.

6.    In section 6, intercept and expenditure coefficients correlate -0.966. This is another value which I am not sure what it means. From what I read, it tells us that if we were to repeat the analysis using a newly sampled dataset, then with newly estimated coefficients of the fixed effect variable, the correlation value tells us how many of those fixed effect coefficients might be associated. You can read more about it [here](https://data.library.virginia.edu/correlation-of-fixed-effects-in-lme4/).

Now that we got a sense of the model summary of a linear mixed effects model, let us see some more functions in R that would be useful for extracting information from the model.

*   To extract the coefficients of the fixed effect variables, use the `fixef()`

quarto-executable-code-5450563D

```r
# Extracting the coefficients of the fixed effects
fixef(model_lmer)
```

*   To extract the coefficients of the random effect variables, use the `ranef()`

quarto-executable-code-5450563D

```r
# Extracting the coefficients of the fixed effects
ranef(model_lmer)
```

*   To calculate the confidence intervals of the fixed effect variables, use the `confint()`

quarto-executable-code-5450563D

```r
# Calculating the confidence intervals of the fixed effects
confint(model_lmer)
```

By default the `confint()` function calculates the confidence intervals at 95% level. The displayed result from the function is symmetric over the 95% level. The interpretation of 95% CI for expenditure, in this case, would be; that if we were to repeat the experiment 100 times, then, the 95 of those mean values of the slope would fall between $-0.000834$ and $0.004796$. We have a rather wide confidence interval which includes both a negative and a positive limit which shows that we cannot say whether expenditure decrease or increase the average reading scores.

*   We can also use the `tidy()` function by loading both the `{broom}` and `{broom.mixed}` packages to display the estimates and the confidence intervals.

quarto-executable-code-5450563D

```r
library(broom)
library(broom.mixed)

# Calculating the estimates and the confidence intervals of the model
tidy(model_lmer, conf.int = T)
```

You can see that the random effect variables do not have standard error values. If we compare the model summary between the linear model and the linear mixed effects model we built, we can also see that p-values are not reported for the linear mixed effects model. The author of the `{lme4}` package, Dr. Doug Bates views random effects as latent variables which do not have standard deviations and thus standard errors or p-values are [not calculated](https://stat.ethz.ch/pipermail/r-help/2006-May/094765.html) for them. In addition to this, it is an open research question on how to calculate the p-values for random effects in a mixed-effects model. But using the `{lmerTest}` package in R we can perform ad-hoc analyses to report p-values for the fixed effect variables. We will see how to do this further down the section.

### Adding a random slope

So far we have seen how to input random intercepts, now we will see how to input random slopes. The default syntax for random effect in R is `(continuous_predictor | random_effect_group)`. Thus a random slope is calculated, it also estimates a random effect intercept.

In the `CASchools` dataset, we looked at whether the average reading score is predicted by the expenditure by treating counties as the random intercept group. Now in our datasets, we also have data on the number of students and this could be different for different counties and can affect the average reading score. So this time let us build a model by treating `students` as the random effect variable.

quarto-executable-code-5450563D

```r
#| include: true

library(lme4)
library(broom.mixed)
library(AER)

data("CASchools")

# Building a linear mixed effects model using random slope and random intercept
model_lmer2 &lt;- lmer(read ~ expenditure + (students | county), data = CASchools)

# Extracting coefficients from the model
summary(model_lmer2)
```

The variance of students is very less and therefore might not be affecting the scores that much. Also, note that we got an error message in the output saying `boundary (singular) fit`. This generally indicates that the estimate for the random effect variable that we used is very small. In our, it means that the random effect slopes of students are very small which we can see using the `ranef()` function. So we can remove `students` from our model.

quarto-executable-code-5450563D

```r
ranef(model_lmer2)
```

### Adding a non-correlated random effects

Please also note that in the model summary given above, a correlation value (-0.95) is given for the correlation between `students` and `county`. If we don't want to specify any correlation between the random effects then instead of using `|` we use `||` to specify no correlation.

quarto-executable-code-5450563D

```r
library(lme4)
library(broom.mixed)
library(AER)

data("CASchools")

# Building a linear mixed effects model (no correlation between random effects)
model_lmer3 &lt;- lmer(read ~ expenditure + (students || county), data = CASchools)

# Extracting coefficients from the model
summary(model_lmer3)
```

The model outputs a lot of error values because `students` and `county` is correlated as seen before.

### Adding the same variable as both fixed and random effect

Sometimes we can have a model with both the fixed effect and the random effect as the same variable. Suppose we are interested in seeing the average effect of expenditure on the average reading scores across counties. In that case, we use `expenditure` both as a fixed effect and as a random effect. Before using `expenditure` in the model formula, it is better to use the `scale()` function to rescale the data values for better numerical stability.

quarto-executable-code-5450563D

```r
library(lme4)
library(broom.mixed)
library(AER)

data("CASchools")

# Rescaling expenditure values
CASchools_scaled &lt;- CASchools
CASchools_scaled$expenditure_scaled &lt;- scale(CASchools_scaled$expenditure)

# Building a linear mixed effects model (same fixed and random effect)
model_lmer4 &lt;- lmer(read ~ expenditure + (expenditure | county), data = CASchools)

# Extracting coefficients from the model
summary(model_lmer4)
```

The table below shows all the different types of random effect syntaxes we can use in the `lmer()` function.

| Random effect syntax | What it means |
|---|---|
| (1 \| group) | Random intercept with fixed mean |
| (1 \| g1/g2) | Intercepts vary among g1 and g2 within g1 |
| (1 \| g1) + (1 \| g2) | Random intercepts for 2 variables |
| x + (x \| g) | Correlated random slope and intercept |
| x + (x \|\| g) | Uncorrelated random slope and intercept |

: Different random effect syntaxes used in the `{lme4}` package

## Plotting lmer models

Earlier we had functions like `fmodel()` from the `{statisticalModeling}` package and arguments like `geom_smooth()` or `stat_smooth()` from the `{ggplot2}` package in R to help us plot linear models and generalized linear models. Thanks to the `{ggeffects}` package in R, we have an easy of plotting our lmer models. But first, let us see how we got it with the `{ggplot2}` package in R.

We will have to do some manual tidying and wrangling of our model object to extract values which we need to plot using the `{ggplot2}` package.

To plot the trend line, we can use the `predict()` function to predict values using the training dataset itself and save those predicted values into a new column in the dataset. Then plot the trend lines them using those predicted values.

quarto-executable-code-5450563D

```r
library(lme4)
library(AER)
library(dplyr)
library(ggplot2)

data("CASchools")

# Building a linear model
model_lm &lt;- lm(read ~ expenditure + county, data = CASchools)

# Building a linear mixed effects model
model_lmer &lt;- lmer(read ~ expenditure + (1 | county), data = CASchools)

# Saving predicted values for each model
data &lt;- CASchools %&gt;% mutate(predicted_lm = predict(model_lm),
                             predicted_lmer = predict(model_lmer))

# Plotting the predicted values as lines
ggplot(data, aes(x = expenditure, y = read, color = county)) +
  geom_point() +
  geom_line(aes(x = expenditure, y = predicted_lm)) +
  geom_line(aes(x = expenditure, y = predicted_lmer), linetype = 'dashed') +
  labs(title = "Linear models vs Linear mixed effects model",
       x = "Expenditure per student (in dollars)",
       y = "Average reading score") +
  theme_bw()

```

We have 54 different counties which make the plot somewhat overwhelming.

We can also plot the predicted values as data points in the plot. Let us build another model without any groups using the same dataset. We will use the number of teachers in the school (`teachers`) as a random effect instead of the counties.

quarto-executable-code-5450563D

```r
library(lme4)
library(AER)
library(dplyr)
library(ggplot2)

data("CASchools")

# Building a linear model
model_lm &lt;- lm(read ~ expenditure + teachers, data = CASchools)

# Building a linear mixed effects model
model_lmer &lt;- lmer(read ~ expenditure + (1 | teachers), data = CASchools)

# Saving predicted values for each model
data &lt;- CASchools %&gt;% mutate(predicted_lm = predict(model_lm),
                             predicted_lmer = predict(model_lmer))

# Plotting the predicted values as points
ggplot(data, aes(x = expenditure, y = read)) +
  geom_point() +
  geom_point(data = data,
             aes(x = expenditure, y = predicted_lm),
             color = "red", alpha = 0.5) +
  geom_point(data = data,
             aes(x = expenditure, y = predicted_lmer),
             color = 'blue', alpha = 0.5) +
  labs(title = "Linear models vs Linear mixed effects model",
       x = "Expenditure per student (in dollars)",
       y = "Average reading score") +
  theme_bw()

```

With the `{ggeffects}` package, plotting a lmer model is as easy as two lines of code. Since we have 54 counties, I am not plotting them via counties, so it is not included in the `terms = "c()"` argument.

quarto-executable-code-5450563D

```r
if (!require(ggeffects)) install.packages('ggeffects')
library(lme4)
library(AER)
library(ggeffects)

data("CASchools")

# Building a linear mixed effects model
model_lmer &lt;- lmer(read ~ expenditure + (1 | county), data = CASchools)

# Predicting values
model_lmer_predict &lt;- ggpredict(model_lmer, terms = c("expenditure"))

# Plotting the model
plot(model_lmer_predict)
```

## Plotting the residulas

We can use the base `plot()` function to plot the residuals of the models.

quarto-executable-code-5450563D

```r
library(lme4)
library(AER)
library(dplyr)
library(ggplot2)

data("CASchools")

# Building a linear model
model_lm &lt;- lm(read ~ expenditure + county, data = CASchools)

# Building a linear mixed effects model
model_lmer &lt;- lmer(read ~ expenditure + (1 | county), data = CASchools)

# Plotting the linear model diagnostics
par(mfrow=c(2,2))
plot(model_lm)

# Plotting the linear mixed effects model diagnostics (just the residuals actually)
plot(model_lmer)
```

## Plotting the cofidence intervals

We can also plot the confidence intervals of the fixed effect variables using the `ggplot()` function.

quarto-executable-code-5450563D

```r
library(lme4)
library(AER)
library(broom)
library(broom.mixed)
library(ggplot2)

data("CASchools")

# Building a linear mixed effects model
model_lmer &lt;- lmer(read ~ expenditure + (1 | county), data = CASchools)

# Extracting the coefficients
model_lmer_coef &lt;- tidy(model_lmer, conf.int = T)
model_lmer_coef1 &lt;- model_lmer_coef %&gt;% 
  filter(effect == "fixed" &amp; term != "(Intercept)")

# Plotting the 95% CI
model_lmer_conf &lt;- ggplot(model_lmer_coef1, aes(x = term, y = estimate,
                             ymin = conf.low, ymax = conf.high)) +
  geom_hline(yintercept = 0, color = 'red') + 
  geom_point() +
  geom_linerange() +
  coord_flip() +
  labs(title = "Linear models vs Linear mixed effects model",
       x = "Regression coefficient",
       y = "Coefficient estimate and 95% CI") +
  theme_bw()

model_lmer_conf
```

Let us try including more fixed effect terms in the model. We will include the number of teachers in the school (`teachers`) and the number of students in the school (`students`) as fixed effects.

quarto-executable-code-5450563D

```r
library(lme4)
library(AER)
library(broom)
library(broom.mixed)
library(ggplot2)

data("CASchools")

# Building a linear mixed effects model
model_lmer &lt;- lmer(read ~ expenditure + teachers + students + (1 | county),
                   data = CASchools)

# Extracting the coefficients
model_lmer_coef &lt;- tidy(model_lmer, conf.int = T)
model_lmer_coef1 &lt;- model_lmer_coef %&gt;% 
  filter(effect == "fixed" &amp; term != "(Intercept)")

# Plotting the 95% CI
model_lmer_conf &lt;- ggplot(model_lmer_coef1, aes(x = term, y = estimate,
                             ymin = conf.low, ymax = conf.high)) +
  geom_hline(yintercept = 0, color = 'red') + 
  geom_point() +
  geom_linerange() +
  coord_flip() +
  labs(title = "Linear models vs Linear mixed effects model",
       x = "Regression coefficient",
       y = "Coefficient estimate and 95% CI") +
  theme_bw()

model_lmer_conf
```

## Null hypothesis testing

As mentioned earlier, p values are not calculated for fixed terms using the `{lme4}` package for various reasons. So if we have to calculate the p values, we have to use the `{lmerTest}` package in R. By loading the `{lmerTest}` package, the `{lme4}` package is automatically loaded. We don't have to provide any special syntax for calculating the p-values, instead, p-values are automatically calculated when calling the `lmer()` function.

quarto-executable-code-5450563D

```r
if (!require(lmerTest)) install.packages('lmerTest')
library(lmerTest)
library(AER)

data("CASchools")

# Building a linear mixed effects model
model_lmer &lt;- lmer(read ~ expenditure + teachers + students + (1 | county),
                   data = CASchools)

# Printing model summary
summary(model_lmer)
```

For fixed effects, p-values are calculated to test if the coefficients are significantly different from zero.

## Model comparison using ANOVA

We can use ANOVA to compare two models to see which one is better. The ANOVA test is called by the function `anova()` and it is used to compare models by comparing the amount of variability explained by each model.

Let us test if the number of teachers significantly affects the average reading score of students across different counties. First, we will build a 'null model' with just `county` as the random effect. Then we will build another model with `teachers` as the fixed effect and the rest the same as the previous model.

quarto-executable-code-5450563D

```r
library(lme4)
library(AER)

data("CASchools")

# Building a linear mixed effects model with only random effect (null model)
model_lmer_null &lt;- lmer(read ~ (1 | county),
                   data = CASchools)

# Building a linear mixed effects model with fixed effect
model_lmer_teacher &lt;- lmer(read ~ teachers + (1 | county),
                   data = CASchools)

# Comparing models using ANOVA
anova(model_lmer_null, model_lmer_teacher)
```

From the ANOVA result, it seems like adding the variable teacher made the model better as it yielded significant p-values.

## Generalized linear mixed effects model

Same way as we made the transition from linear models to generalized linear models, we now transition from linear mixed effects model to generalized mixed effects model. As you might have guessed, we will be dealing with datasets which do not follow the normal distribution and are in the form of a count or binomial type.

We use the `glmer()` function to build generalized linear mixed effects models (glmer models) and use the `family = " "` argument to specify the distribution of residuals of the data. If it's non-normal and is count then we use `family = "poisson"` and if it's binomial then we use `family = "binomial"`.

### Logistic mixed effects model

For this exercise, we will be using the `CreditCard` dataset from the `{AER}` package in R. The dataset contains the credit history of a sample of applicants for a type of credit card. We will be building a glmer model to predict the success of the acceptance of the credit card application (`card`) using yearly income (`income`) as the fixed effect and the house ownership status (`owner`) as the random effect.

Let us first build a plot and visualize the data before building the model.

quarto-executable-code-5450563D

```r
library(ggplot2)
library(AER)

data("CreditCard")

# Plotting the data
ggplot(CreditCard, aes(income, card, col = owner)) +
  geom_jitter(width = 0, height = 0.05) +
  labs(title = "Does income affect the success in accepting a credit card application?",
       x = "Yearly income (in USD 10,000)",
       y = "Was the application for a credit card accepted?") +
  theme_bw()

```

It seems like individuals with low yearly income tend to have the most number of credit card application rejections.

Now let us build the model.

quarto-executable-code-5450563D

```r
library(lme4)
library(AER)

data("CreditCard")

# Building a logistic mixed effects model
model_glmer_logistic &lt;- glmer(card ~ income + (1 | owner), family = "binomial",
                           data = CreditCard)

# Printing the summary of the model
summary(model_glmer_logistic)
```

From a quick look, it seems like income does significantly explain the variance seen in the success of accepting a credit card application.

We learned from logistic GLMs that it's easier to interpret the coefficients as odds ratio by exponentiating them. The same principle follows here.

quarto-executable-code-5450563D

```r
library(lme4)
library(broom)
library(broom.mixed)
library(AER)

data("CreditCard")

# Building a logistic mixed effects model
model_glmer_logistic &lt;- glmer(card ~ income + (1 | owner), family = "binomial",
                           data = CreditCard)

# Extracting the odds ratios
tidy(model_glmer_logistic, exponentiate = T)
```

We can see that the odds ratio for income is very close to 1, which is why the p-value associated with income is close to the level of significance of 0.05. So there is a weak effect on income in deciding the success of accepting credit card applications. There might be some other variables that we are missing to incorporate into the model.

### Plotting a logistic mixed effects model

As we saw in the case with the linear mixed effects model, we will be using the `{ggeffects}` package.

quarto-executable-code-5450563D

```r
library(lme4)
library(ggeffects)
library(AER)

data("CreditCard")

# Building a logistic mixed effects model
model_glmer_logistic &lt;- glmer(card ~ income + (1 | owner), family = "binomial",
                           data = CreditCard)

# Predicting values
model_glmer_logistic_predict &lt;- ggpredict(model_glmer_logistic, "income")

# Plotting the model
plot(model_glmer_logistic_predict)
```


### Poisson mixed effects model

For this exercise, we will be using the `RecreationDemand` dataset from the `{AER}` package in R. The data is on the number of recreational boating trips to Lake Somerville, Texas, in 1980, based on a survey administered to 2,000 registered leisure boat owners in 23 counties in eastern Texas, USA.

We will be predicting the number of boating trips (`trips`) using the annual household income of the respondent (`income`) as the fixed effect and water-skiing status at the lake (`ski`) as the random effect.

Let us first build a plot and visualize the data before building the model.

quarto-executable-code-5450563D

```r
library(ggplot2)
library(AER)

data("RecreationDemand")

# Plotting the data
ggplot(RecreationDemand, aes(income, trips, col = ski)) + 
  geom_jitter(width = 0.05, height = 0) +
  labs(title = "Does income affect the number of recreational boating trips?",
       x = "Annual household income of the respondent (in 1,000 USD)",
       y = "Number of recreational boating trips") +
  theme_bw()

```

The graph tells us that most boating trips are made by people with less annual household income. Please note that there are many zeros in the dataset, essentially we have a zero-inflated dataset. But for now, we will ignore it. Skiing status doesn't seem to affect the number of boating trips made.

Now let us build the model and see.

quarto-executable-code-5450563D

```r
library(lme4)
library(AER)

data("RecreationDemand")

# Building a poisson mixed effects model
model_glmer_poisson &lt;- glmer(trips ~ income + (1 | ski), family = "poisson",
                           data = RecreationDemand)

# Printing the summary of the model
summary(model_glmer_poisson)
```

Seems like income has a significant negative impact on the number of boating trips as seen earlier in the graph.

### Plotting a Poisson mixed effects model

Again we will be using the `{ggeffects}` package.

quarto-executable-code-5450563D

```r
library(lme4)
library(ggeffects)
library(AER)

data("RecreationDemand")

# Building a poisson mixed effects model
model_glmer_poisson &lt;- glmer(trips ~ income + (1 | ski), family = "poisson",
                           data = RecreationDemand)

# Predicting values
model_glmer_poisson_predict &lt;- ggpredict(model_glmer_poisson,
                                         terms = c("income", "ski"))

# Plotting the model
plot(model_glmer_poisson_predict)
```

## Repeated measures data

If we measure variables across time for the same set of observations then essentially we have repeated measures data. Repeated measures are a special case of a mixed-effects model. Examples of repeated measures include; tracking test scores of students across an academic year, measuring drug effects on patients over time, measuring the growth of bacteria over time, measuring flower phenology over different seasons etc.

We will be using the `sleep` dataset from the `{datasets}` package in R. The data show the effect of two soporific drugs (increase in hours of sleep compared to control) on 10 patients. In this case, we are measuring sleep difference in hours across time (`extra`) for two groups (`group`), essentially repeated measured data.

First, let us visualize the dataset.

quarto-executable-code-5450563D

```r
if (!require(datasets)) install.packages('datasets')
library(datasets)
library(ggplot2)

data("sleep")

# Plotting the graph
ggplot(sleep, aes(group, extra, group = ID)) + geom_line() +
  labs(title = "Effect of two soporific drugs on sleep in 10 patients",
       x = "Drug group",
       y = "Increase in hours of sleep compared to control") +
  theme_bw()
```

The graph shows that drug 2 as compared to drug 1 increases the amount of sleep in hours when compared to control. Now let us see if this difference is statistically significant.

In introductory statistic classes, we would have learned that to compare means across time for this 'paired' dataset, we can use a paired t-test. Performing a t-test in R is through the `t.test()` function. If we use `t.test(paired = T)` then essentially we are doing a paired t.test. Let us do a paired t-test on the above-mentioned dataset.

quarto-executable-code-5450563D

```r
library(datasets)

data("sleep")

# Performing a paired t.test
t.test(extra ~ group, paired = T, data = sleep)
```

The t-test results suggest a significant difference between the mean of the sleep differences and the difference between the mean of the sleep difference between the two groups is -1.58. In other words, group 2 has a 1.58 value greater mean as compared to group 1. 

Now let us run a linear mixed effects model with `extra` as the response variable, `group` as the fixed effect and the `ID` as the random effect. 

quarto-executable-code-5450563D

```r
library(datasets)

data("sleep")

# Building a linear mixed effect model
summary(lmer(extra ~ group + (1 | ID), data = sleep))
```

If we closely compare the paired t-test result and the summary of the linear mixed effect model, we can notice some similarities.

1.    The test statistic t-value is the same in both the results if we ignore the sign (4.062).
2.    The p-value is the same (0.00283)
3.    The coefficient for the group2 is the same as the mean difference denoted in the paired t-test result after ignoring the sign (1.5800).

Paired t-test is a special case of repeated measures ANOVA. If we have only two dependent groups and if it's normally distributed, then we use the paired t-test to compare their means. If we have more than 2 dependent groups, then we go repeated measures ANOVA. On the other hand, repeated measures ANOVA is a special case of the mixed effects model.

So to compare the means for paired data, we can go for two different statistical approaches; 

1.    Regression analysis
2.    ANOVA type approach

We already saw the regression analysis approach which is what we did earlier. Here, we build a linear mixed model and then examine if the drug group coefficient differs greatly from zero. In our case, the coefficient for group2 is 1.58 and is significantly greater than 0. So we can directly see that group2 significantly affects extra hours of sleep as compared to group1, without the need for any post hoc test which is needed if we are running an ANOVA.

So the null and alternate hypotheses for the *regression analysis* of our data would be;

*   $H_0$ = Drug group coefficient is zero
*   $H_a$ = Drug group coefficient is not zero

In the second approach, we examine if the drug group covariate explains a significant amount of variability within the model. There will be no effect on the drug group if the amount of sleep the study participants get in both groups is similar. ANOVA will only tell that there is a significant difference between some groups in the model, to see which groups differ from each other, we have to go for a post hoc test.

So the null and alternate hypothesis for the *ANOVA type approach* for our data would be;

*   $H_0$ = Drug group does not significantly explain the differences in extra sleep hours
*   $H_a$ = Drug group significantly explain the differences in extra sleep hours

Going forward with the ANOVA type approach can be as easy as using the function `anova()` by giving the model as the input.

quarto-executable-code-5450563D

```r
library(datasets)

data("sleep")

# Building a linear mixed effects model
sleep_model &lt;- lmer(extra ~ group + (1 | ID), data = sleep)

# Performing a ANOVA
anova(sleep_model)
```

As we have seen earlier, the drug group does significantly explain the differences in extra sleep hours of the patients. We can also see that the p-values calculated are identical to that of the model summary we saw before.

## Fixed effect models (lm and glm) vs Mixed effects models (lmer and glmer)

We have reached the final level of the tutorial. Here we will compare the fixed effects models and mixed effects models and get an overall picture of the differences between them.

| Fixed effects model | Mixed effects model |
|---|---|
| Generally more impacted by outliers | More robust to outliers |
| Use `lm()` or `glm()` in base R | Use `lmer()` or `glmer()` from `{lme4}` package in R |
| Easier to explain | Computationally harder to fit |
| Easier to build | More robust to small group sizes |
|  | Models nested distributions |

: Review of fixed effects model and mixed effects model

## Conlusion

Finally, we have completed the most needed things in statistical modelling that concerns a PhD student, especially if that student is studying Ecology. In summary, we learned the following things;

1.    What is a hierarchical model/mixed effects model?

2.    What are fixed effects and random effects?

3.    Building a linear mixed effects model

4.    Adding random intercept group and random effect slope

5.    Random effect syntaxes used in `{lme4}` packages

6.    Plotting linear mixed effects model, the residuals and the confidence intervals

7.    Model comparison using ANOVA

8.    Building generalized mixed effects models: *Logistic* and *Poisson*

9.    Plotting generalized mixed effects models

10.   Repeated measures data

11.   Paired t-test and repeated measures ANOVA is a special case of mixed effects model

Now where to go from here? Normally, whatever is covered till now will be enough for most purposes as a student of science. Now if you the reader is still interested in learning more, then I welcome you to learn 'Non-linear Modelling in R with Generalized Additive Models (GAM)' which would raise our modelling repertoire to even higher levels. Congratulations for making it this far, I wish you all the best 👍 

#### Last updated on {.unnumbered .unlisted .appendix}

quarto-executable-code-5450563D

```r
#| echo: false
Sys.time()
```

&lt;!-- Do not forget to put flag counter --&gt;
&lt;a hidden href="https://info.flagcounter.com/ynrK"&gt;&lt;img src="https://s11.flagcounter.com/count2/ynrK/bg_000000/txt_FFFFFF/border_F0F0F0/columns_5/maxflags_25/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" alt="Flag Counter" border="0"/&gt;&lt;/a&gt;</code></pre>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">Blog made using <a href="https://quarto.org/">Quarto®</a> with ❤️, by Jewel Johnson.</div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jeweljohnsonj">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/jeweljohnsonj">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:jewel15@alumni.iisertvm.ac.in">
      <i class="bi bi-briefcase" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:jeweljohnsonj@gmail.com">
      <i class="bi bi-house" role="img">
</i> 
    </a>
  </li>  
</ul>
</div>
  </div>
</footer><div class="page-columns page-rows-contents page-layout-article"><div class="social-share">
<a href="https://twitter.com/share?url=https://one-carat-blog.netlify.app/tutorials/stat_model/glmer_stat_model.html&amp;text=Hierarchical%20and%20Mixed%20Effects%20Models%20in%20R" target="_blank" class="twitter"><i class="fab fa-twitter fa-fw fa-lg"></i></a><a href="https://www.linkedin.com/shareArticle?url=https://one-carat-blog.netlify.app/tutorials/stat_model/glmer_stat_model.html&amp;title=Hierarchical%20and%20Mixed%20Effects%20Models%20in%20R" target="_blank" class="linkedin"><i class="fa-brands fa-linkedin-in fa-fw fa-lg"></i></a>  <a href="mailto:?subject=Hierarchical%20and%20Mixed%20Effects%20Models%20in%20R&amp;body=Check%20out%20this%20link:https://one-carat-blog.netlify.app/tutorials/stat_model/glmer_stat_model.html" target="_blank" class="email"><i class="fa-solid fa-envelope fa-fw fa-lg"></i></a><a href="https://www.facebook.com/sharer.php?u=https://one-carat-blog.netlify.app/tutorials/stat_model/glmer_stat_model.html" target="_blank" class="facebook"><i class="fab fa-facebook-f fa-fw fa-lg"></i></a><a href="https://reddit.com/submit?url=https://one-carat-blog.netlify.app/tutorials/stat_model/glmer_stat_model.html&amp;title=Hierarchical%20and%20Mixed%20Effects%20Models%20in%20R" target="_blank" class="reddit">   <i class="fa-brands fa-reddit-alien fa-fw fa-lg"></i></a><a href="https://www.stumbleupon.com/submit?url=https://one-carat-blog.netlify.app/tutorials/stat_model/glmer_stat_model.html&amp;title=Hierarchical%20and%20Mixed%20Effects%20Models%20in%20R" target="_blank" class="stumbleupon"><i class="fa-brands fa-stumbleupon fa-fw fa-lg"></i></a><a href="https://www.tumblr.com/share/link?url=https://one-carat-blog.netlify.app/tutorials/stat_model/glmer_stat_model.html&amp;name=Hierarchical%20and%20Mixed%20Effects%20Models%20in%20R" target="_blank" class="tumblr"><i class="fa-brands fa-tumblr fa-fw fa-lg"></i></a>
</div></div>



<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>